# 差分調査・現状分析・修正プラン

> **調査日:** 2026年2月9日
> **対象:** 資格取得申請システム（Power Apps / Power Automate / SharePoint）
> **目的:** GitHub仕様書と実装済み環境を比較し、修正すべき箇所を特定する

---

## 目次

1. [修正の背景と仕様](#1-修正の背景と仕様)
2. [全体の進捗状況](#2-全体の進捗状況)
3. [Power Apps 差分分析](#3-power-apps-差分分析)
4. [Power Automate 差分分析](#4-power-automate-差分分析)
5. [SharePoint データ分析](#5-sharepoint-データ分析)
6. [発見された問題一覧](#6-発見された問題一覧)
7. [修正プラン](#7-修正プラン)
8. [Power Apps 具体的な修正手順](#8-power-apps-具体的な修正手順)
9. [Power Automate 具体的な修正手順](#9-power-automate-具体的な修正手順)
10. [テスト計画](#10-テスト計画)

---

## 1. 修正の背景と仕様

### 仕様変更の内容

「資格取得宣言届出」を**単なる事前申請**とし、別途「資格取得届出」を提出した際に**報奨金＋事前申請ボーナス5,000円**が支給される方式に変更。

### 報奨金ルール

| 申請種別 | 報奨金 | 事前ボーナス | 説明 |
|---------|--------|------------|------|
| 資格取得宣言届 | 0円（表示しない） | 0円 | 事前の宣言のみ。報奨金は取得届提出時に確定 |
| 資格取得届（宣言届あり） | マスタから取得 | **+5,000円** | 事前に宣言届を提出していた場合ボーナス加算 |
| 資格取得届（宣言届なし） | マスタから取得 | 0円 | 報奨金のみ |

### 業務フロー

```
従業員が資格取得を決意
    │
    ├─ 資格取得宣言届を提出（任意）
    │     └─ 承認 → 受付完了（金額なし）
    │
    ▼
従業員が資格を取得
    │
    └─ 資格取得届を提出
          ├─ 過去の宣言届を紐づけ → 報奨金 + ¥5,000 ボーナス
          └─ 紐づけなし → 報奨金のみ
```

---

## 2. 全体の進捗状況

| コンポーネント | 進捗 | 概要 |
|---------------|------|------|
| **SharePoint リスト** | ✅ 100% | 列構成は全て完了。関連宣言届ID・最終支給額列も存在 |
| **Power Apps** | 🟡 約90% | 主要ロジック実装済み。フィルター改善と関連ID送信が残っている |
| **Power Automate** | 🟠 約70% | 基本構造は構築済み。取得届分岐の確認と遅延追加が必要 |

---

## 3. Power Apps 差分分析

### 3.1 コントロール一覧（ツリービュー確認済み）

| コントロール名 | 種類 | 役割 | GitHub仕様名 |
|---------------|------|------|-------------|
| RadioApplicationType | ラジオボタン | 申請種別の選択 | RadioApplicationType |
| DropdownCategory | ドロップダウン | 分類の選択 | DropdownCategory |
| DropdownQualification | ドロップダウン | 資格名の選択 | DropdownQualification |
| DropdownDetail | ドロップダウン | 詳細の選択 | DropdownDetail |
| Dropdown1 | ドロップダウン | 過去の宣言届出 | Dropdown1 |
| DatePickerAcquisition | 日付選択 | 取得予定日/取得日 | DatePickerAcquisition |
| TextInputReason | テキスト入力 | 理由・内容 | TextInputReason |
| ButtonSubmit | ボタン | 申請するボタン | ButtonSubmit |
| lbl取得日 | ラベル | 日付ラベルの動的切替 | （仕様にあり） |
| Label3 | ラベル | 報奨金表示 | LabelReward |

### 3.2 各プロパティの比較

#### ✅ RadioApplicationType.Items — 一致

```
GitHub仕様: ["資格取得宣言届", "資格取得届"]
現状:       ["資格取得宣言届", "資格取得届"]
Default:    "資格取得宣言届"
```

#### ✅ DropdownCategory.Items — 一致

```
Table(
    {Value: "税務"}, {Value: "会計"}, {Value: "お金"},
    {Value: "労務社保"}, {Value: "給与"}, {Value: "IT"}, {Value: "その他"}
)
```

#### ✅ DropdownQualification.Items — 一致

```
Distinct(
    Filter(資格マスタ, 分類 = DropdownCategory.Selected.Value),
    Title
)
```

#### ✅ DropdownDetail.Items — 一致

```
Distinct(
    Filter(資格マスタ, Title = DropdownQualification.Selected.Value),
    詳細
)
```

#### ⚠️ Dropdown1.Items（過去の宣言届出）— 要修正

```
// 現状（問題あり）
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
)
```

**問題：** 全ての宣言届が表示される。同じ資格名に絞られていない。ステータスでフィルターされていない。

#### ✅ Dropdown1.Visible — 一致

```
RadioApplicationType.Selected.Value = "資格取得届"
```

#### ✅ lbl取得日.Text — 一致

```
If(
    RadioApplicationType.Selected.Value = "資格取得宣言届",
    "取得予定日",
    "取得日"
)
```

#### ✅ 報奨金ラベル.Text — 一致

5パターン分岐が正しく実装済み：
1. 宣言届 → 報奨金なしメッセージ
2. 取得届 + 報奨金0 + ボーナスあり → 受験料相当額 + ¥5,000
3. 取得届 + 報奨金0 + ボーナスなし → 受験料相当額
4. 取得届 + 報奨金>0 + ボーナスあり → ¥XX,XXX + ¥5,000
5. 取得届 + 報奨金>0 + ボーナスなし → ¥XX,XXX

#### ✅⚠️ ButtonSubmit.OnSelect — ほぼ一致（軽微な差異あり）

**送信済みフィールド:**
| フィールド | 状態 | 値 |
|-----------|------|-----|
| Title | ✅ 送信済 | `資格名 & " " & 詳細` |
| 申請種別 | ✅ 送信済 | RadioApplicationType.Selected |
| 申請日 | ✅ 送信済 | Today() |
| 予定日_取得日 | ✅ 送信済 | DatePickerAcquisition.SelectedDate |
| 理由_内容 | ✅ 送信済 | TextInputReason.Text |
| ステータス | ✅ 送信済 | {Value: "申請中"} |
| 報奨金額 | ✅ 送信済 | 宣言届→0 / 取得届→LookUpで取得 |
| 事前ボーナス | ✅ 送信済 | 取得届+Dropdown1選択あり→5000 / それ以外→0 |
| 取得資格（Lookup列） | ⚠️ 未送信 | Title文字列で代用中 |
| **関連宣言届ID** | ❌ 未送信 | **宣言届との紐づけが記録されない** |

### 3.3 Power Apps サマリー

| 項目 | 状態 | 備考 |
|------|------|------|
| 申請種別ラジオボタン | ✅ 完了 | 仕様通り |
| カスケードドロップダウン（3段） | ✅ 完了 | 仕様通り |
| 過去の宣言届出 表示切替 | ✅ 完了 | 取得届の時のみ表示 |
| 過去の宣言届出 フィルター | ⚠️ **要修正** | 同じ資格＋承認済みに絞る必要あり |
| 動的ラベル切替（取得予定日/取得日） | ✅ 完了 | 仕様通り |
| 報奨金表示ロジック（5パターン） | ✅ 完了 | 仕様通り |
| Patch関数（基本フィールド） | ✅ 完了 | 条件分岐含め正しい |
| Patch関数（関連宣言届ID） | ❌ **未実装** | 宣言届のIDが記録されない |

---

## 4. Power Automate 差分分析

### 4.1 フロー構造の比較

<table>
<tr>
<th>GitHub仕様のフロー構造</th>
<th>現在のフロー構造</th>
</tr>
<tr>
<td>

```
1. 項目が作成されたとき
2. 遅延（10秒）
3. 項目の取得
4. 作成（報奨金表示テキスト）
5. 開始して承認を待機
6. 条件（承認/却下）
   ├─ True
   │  ├─ 項目の更新（承認済）
   │  └─ 条件1（宣言届?）
   │     ├─ True → Teams通知1
   │     └─ False
   │        └─ 条件2（ボーナス?）
   │           ├─ True → Teams通知2
   │           └─ False → Teams通知3
   └─ False
      ├─ 項目の更新（却下）
      └─ Teams通知4
```

</td>
<td>

```
1. 項目が作成されたとき
   （遅延なし）
   （項目の取得なし）
2. 項目の更新 2（初期値セット）
3. 作成（報奨金表示テキスト）
4. 開始して承認を待機
5. 条件（承認/却下）
   ├─ True
   │  └─ 条件1（宣言届?）
   │     ├─ True
   │     │  ├─ Teams通知2
   │     │  └─ For each→項目の更新
   │     └─ False
   │        └─ 1件のアクション（折畳）
   └─ False
      ├─ 項目の更新 1（却下）
      ├─ Teams通知1
      └─ For each 1→項目の更新 4
```

</td>
</tr>
</table>

### 4.2 アクション別詳細比較

#### ✅ 1. トリガー: 項目が作成されたとき — 一致

| 設定 | 値 |
|------|-----|
| サイト | `https://armaascojp.sharepoint.com/sites/arma-as.co.jp` |
| リスト名 | `資格取得申請` |

#### ❌ 2. 遅延（10秒）— 存在しない

| 項目 | 内容 |
|------|------|
| GitHub仕様 | 10秒の遅延（SharePointへの書き込み完了を待つため） |
| 現状 | **遅延アクションがない** |
| 影響 | データ書き込み完了前にフローが動くリスク。ただし「項目の更新 2」がwrite操作であるため、タイミング問題は緩和されている可能性あり |

#### ⚠️ 3. 「項目の取得」→「項目の更新 2」— アプローチが異なる

GitHub仕様では「項目の取得」で読み取りのみだが、現状は「項目の更新 2」でデータセットと読み取りを兼用：

| パラメータ | 設定値 |
|-----------|--------|
| サイト | armaascojp.sharepoint.com/sites/arma-as.co.jp |
| リスト名 | 資格取得申請 |
| ID | body/ID（トリガーから） |
| タイトル | タイトル（トリガーから） |
| 申請者 Claims | 登録者 Email |
| ステータス Value | 申請中 |
| 報奨金額 | 報奨金額（トリガーから） |
| 事前ボーナス | 事前ボーナス（トリガーから） |

> **評価:** 機能的には問題なし。更新の出力で最新データを取得できるため「項目の取得」と同等の役割を果たしている。

#### ✅ 4. 作成（報奨金表示テキスト）— 実装済み（GitHub仕様より堅牢）

```
if(
    or(
      equals(outputs('項目の更新_2')?['body/申請種別/Value'], '資格取得宣言届'),
      equals(outputs('項目の更新_2')?['body/OData__x7533__x8acb__x7a2e__x5225_/Value'], '資格取得宣言届'),
      contains(string(outputs('項目の更新_2')?['body']), '宣言届')
    ),
    '※報奨金は資格取得後の届出時に確定します',
    ... 報奨金表示ロジック（5パターン） ...
)
```

> **評価:** `or()` で3通りの宣言届判定を行っており、OData列名の不一致にも対応。**GitHub仕様より堅牢な実装。**

#### ✅⚠️ 5. 開始して承認を待機 — 実装済み（軽微な差異）

| 設定 | GitHub仕様 | 現状 | 状態 |
|------|-----------|------|------|
| 承認の種類 | 承認/拒否 - 最初に応答 | 承認/拒否 - 最初に応答 | ✅ |
| タイトル | `資格取得申請の承認依頼: {Title}` | `【資格取得申請】承認依頼`（資格名なし） | ⚠️ |
| 担当者 | 上司のメール | yiwao@arma-as.co.jp（テスト用） | - |
| 詳細 | 申請者, 資格名, 取得予定日, 理由, 報奨金 | 同左（「作成」の出力を使用） | ✅ |

#### ✅ 6. 条件（承認/却下の判定）— 一致

```
body/outcome = Approve
```

#### ✅ 7. 条件1（宣言届/取得届の判定）— 実装済み

```
body/OData_x...（申請種別） = 資格取得宣言届
```

#### ✅ 8. Teams通知（宣言届承認）— 条件1 True — 実装済み

| 設定 | 値 | 状態 |
|------|-----|------|
| 投稿者 | フローボット | ✅ |
| 投稿先 | フローボットとチャットをする | ✅ |
| Recipient | 申請者 Email | ✅ |
| メッセージ | 宣言届承認 + 取得届提出の案内 + ¥5,000加算の案内 | ✅ |

#### ⚠️ 9. 承認時の項目の更新 — 配置が異なる

| 項目 | GitHub仕様 | 現状 |
|------|-----------|------|
| 配置 | 条件1の**前**に1つ | 条件1のTrue内（For each内）に配置 |
| ステータス | 承認済 | 承認済 ✅ |
| 承認者 | 応答者 | responder/DisplayName ✅ |
| 承認日 | utcNow() | 承認日 ✅ |

> **注意:** 条件1のFalse分岐（取得届）にも同様の「項目の更新」があるかは未確認。

> **For eachについて:** Power Automateでは、承認応答プロパティ（responderなど）を参照すると自動的にFor eachが生成されることがある。「最初に応答」の承認タイプでは実質1件なので動作に問題なし。

#### ❓ 10. 条件1 False分岐（取得届の場合）— 未確認

| 項目 | 内容 |
|------|------|
| GitHub仕様 | 条件2（事前ボーナス > 0）→ Teams通知パターン2/3 |
| 現状 | **「1件のアクション」と折りたたまれており中身が確認できない** |

> ⚠️ **この部分は最優先で展開・確認が必要。** 条件2とTeams通知パターン2/3が未実装であれば、取得届承認時にTeams通知が送信されない可能性あり。

#### ✅ 11. 却下時の処理 — 実装済み（追加要素あり）

| アクション | 設定 | 状態 |
|-----------|------|------|
| 項目の更新 1 | ステータス: 却下, 承認日: 完了日 | ✅ |
| Teams通知1 | 却下メッセージ + 却下理由（応答の概要）表示 | ✅ |
| For each 1 → 項目の更新 4 | ステータス: 申請中（⚠️意図不明） | ⚠️ 要確認 |

> **項目の更新 4について:** 却下時にステータスを「申請中」に設定している。関連アイテムのリセット目的か？要確認。

#### ✅⚠️ 12. Teams通知（却下）— 実装済み（軽微な差異）

| 設定 | 値 | 状態 |
|------|-----|------|
| Recipient | 登録者 Email（仕様は「申請者 Email」） | ⚠️ 差異あり |
| メッセージ | 却下通知 + 資格名 + **却下理由（応答の概要）** | ✅（却下理由はGitHub仕様にないが有用な追加） |

### 4.3 Power Automate サマリー

| 項目 | 状態 | 優先度 |
|------|------|--------|
| トリガー | ✅ 完了 | - |
| 遅延（10秒） | ❌ 未実装 | 🟡 推奨 |
| 項目の更新 2（データ取得） | ✅ 完了 | - |
| 作成（報奨金ロジック） | ✅ 完了 | - |
| 承認アクション | ✅ 完了 | タイトルに資格名追加（任意） |
| 条件（承認/却下） | ✅ 完了 | - |
| 条件1（宣言届判定） | ✅ 完了 | - |
| Teams通知（宣言届承認） | ✅ 完了 | - |
| 承認時の項目の更新 | ⚠️ 要確認 | 🔴 必須 |
| **条件2（ボーナス有無判定）** | ❓ **未確認** | 🔴 必須 |
| **Teams通知（取得届＋ボーナスあり）** | ❓ **未確認** | 🔴 必須 |
| **Teams通知（取得届＋ボーナスなし）** | ❓ **未確認** | 🔴 必須 |
| 却下時の処理 | ✅ 完了 | - |
| 項目の更新 4（却下時 For each内） | ⚠️ 要確認 | 🟡 推奨 |

---

## 5. SharePoint データ分析

### 5.1 CSVエクスポートデータ（2026/2/9時点）

| 資格名 | 申請種別 | 申請者 | ステータス | 報奨金額 | 事前ボーナス | 関連宣言届ID | 最終支給額 |
|--------|---------|--------|-----------|---------|------------|------------|-----------|
| 日商簿記検定 2級 | 資格取得宣言届 | 岩男 祐多 | ⚠️ 申請中 | 0 | 0 | （空） | （空） |
| 公認会計士試験 短答式合格 | 資格取得宣言届 | 岩男 祐多 | ✅ 承認済 | 0 | 0 | （空） | （空） |

### 5.2 分析結果

| 確認項目 | 結果 | 詳細 |
|---------|------|------|
| 列構成 | ✅ OK | 報奨金額、事前ボーナス、関連宣言届ID、最終支給額の列が全て存在 |
| 宣言届の報奨金額 | ✅ OK | 0で正しい（Power Appsの条件分岐が正常動作） |
| 宣言届の事前ボーナス | ✅ OK | 0で正しい |
| 承認日 | ⚠️ 空 | 承認済みレコードでも承認日が空。項目の更新で承認日が正しくセットされていない可能性 |
| 1件目のステータス | ⚠️ 申請中のまま | フロー未処理またはフローオフだった可能性 |
| 取得届テストデータ | ❌ なし | 取得届のテスト申請がまだ行われていない |

---

## 6. 発見された問題一覧

| No. | 対象 | 問題内容 | 深刻度 | 優先度 |
|-----|------|---------|--------|--------|
| 1 | Power Apps | Dropdown1が全ての宣言届を表示。同じ資格＋承認済みに絞られていない | 🟡 中 | 🔴 必須 |
| 2 | Power Apps | Patch関数に「関連宣言届ID」が未送信。紐づけがSharePoint上で追跡不可 | 🟡 中 | 🔴 必須 |
| 3 | Power Automate | 条件1 False分岐（取得届承認時）の内容が未確認。条件2やTeams通知が正しいか不明 | 🔴 高 | 🔴 必須 |
| 4 | Power Automate | 遅延（10秒）がない。書き込み前にフローが動くリスク | 🟡 中 | 🟡 推奨 |
| 5 | Power Automate | 承認時の項目の更新が取得届分岐にもあるか不明 | 🟡 中 | 🔴 必須 |
| 6 | Power Automate | 承認タイトルに資格名がない | 🟢 低 | 🟢 任意 |
| 7 | Power Automate | 項目の更新 4（却下時）がステータスを「申請中」にしている。意図不明 | 🟡 中 | 🟡 推奨 |
| 8 | SharePoint | 承認済みレコードの承認日が空 | 🟢 低 | 🟡 推奨 |

---

## 7. 修正プラン

### Phase 0: 追加調査（最優先）

> ⚠️ **Phase 1, 2 の作業前に必ず実施してください**

#### 調査0-1: 条件1のFalse分岐を展開して確認

1. Power Automateのフロー編集画面を開く
2. 条件（承認/却下）→ True → 条件1 を見つける
3. **「False」分岐の「1件のアクション」をクリック**して展開する
4. 中に何があるかスクリーンショットを撮る

**確認ポイント:**
- [ ] 「条件2」（事前ボーナス > 0 の条件分岐）はあるか？
- [ ] Teams通知（取得届＋ボーナスあり）のアクションはあるか？
- [ ] Teams通知（取得届＋ボーナスなし）のアクションはあるか？
- [ ] 項目の更新（承認済）のアクションはあるか？

#### 調査0-2: 項目の更新 4 の意図を確認

1. 却下分岐内の「For each 1 → 項目の更新 4」を展開
2. どのリストのどのIDを更新しているか確認
3. 全パラメータのスクリーンショットを撮る

---

### Phase 1: Power Apps の修正

| 修正 | 内容 | 優先度 |
|------|------|--------|
| 1-1 | Dropdown1のフィルター改善（同じ資格＋承認済みに絞る） | 🔴 必須 |
| 1-2 | Patch関数に関連宣言届IDを追加 | 🔴 必須 |

### Phase 2: Power Automate の修正

| 修正 | 内容 | 優先度 |
|------|------|--------|
| 2-1 | 遅延（10秒）をトリガー直後に追加 | 🟡 推奨 |
| 2-2 | 条件1 False分岐の確認・修正（条件2 + Teams通知2/3） | 🔴 必須 |
| 2-3 | 承認タイトルに資格名を追加 | 🟢 任意 |
| 2-4 | 項目の更新 4 の確認・修正 | 🟡 推奨 |

### Phase 3: テスト

| テスト | 内容 |
|--------|------|
| 3-1 | 宣言届 → 承認 → 金額なしTeams通知 |
| 3-2 | 取得届（宣言届あり）→ 承認 → 報奨金+5,000円表示 |
| 3-3 | 取得届（宣言届なし）→ 承認 → 報奨金のみ表示 |
| 3-4 | 却下テスト |

---

## 8. Power Apps 具体的な修正手順

### 修正1-1: Dropdown1のフィルターを改善

**現在のDropdown1.Items:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
)
```

**修正後のDropdown1.Items:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
        && ステータス.Value = "承認済"
        && StartsWith(Title, DropdownQualification.Selected.Value)
)
```

**変更点:**
- `ステータス.Value = "承認済"` — 承認済みの宣言届のみに絞る
- `StartsWith(Title, DropdownQualification.Selected.Value)` — 選択中の資格名で始まるもののみに絞る

> **注意:** Titleが「公認会計士試験 短答式合格」のように「資格名 詳細」の形式で保存されているため、`StartsWith`で資格名部分を一致させています。

**手順:**
1. Power Apps Studio で対象アプリを開く
2. 左のツリービューから `Dropdown1` を選択
3. `Items` プロパティを選択
4. 既存の式を全選択（Ctrl+A）して削除
5. 上記の修正後の式を貼り付け

---

### 修正1-2: Patch関数に関連宣言届IDを追加

**修正後のButtonSubmit.OnSelect（全体）:**
```
Patch(
    資格取得申請,
    Defaults(資格取得申請),
    {
        Title: DropdownQualification.Selected.Value & " "
            & DropdownDetail.Selected.Value,
        申請種別: RadioApplicationType.Selected,
        申請日: Today(),
        予定日_取得日: DatePickerAcquisition.SelectedDate,
        理由_内容: TextInputReason.Text,
        ステータス: {Value: "申請中"},
        報奨金額: If(
            RadioApplicationType.Selected.Value = "資格取得宣言届",
            0,
            LookUp(
                資格マスタ,
                Title = DropdownQualification.Selected.Value
                    && 詳細 = DropdownDetail.Selected.Value,
                報奨金
            )
        ),
        事前ボーナス: If(
            RadioApplicationType.Selected.Value = "資格取得届"
                && !IsBlank(Dropdown1.Selected),
            5000,
            0
        ),
        関連宣言届ID: If(
            RadioApplicationType.Selected.Value = "資格取得届"
                && !IsBlank(Dropdown1.Selected),
            Dropdown1.Selected.ID,
            Blank()
        )
    }
);
Navigate(Screen2, ScreenTransition.Fade)
```

**追加した部分:**
```
関連宣言届ID: If(
    RadioApplicationType.Selected.Value = "資格取得届"
        && !IsBlank(Dropdown1.Selected),
    Dropdown1.Selected.ID,
    Blank()
)
```

> **注意:** `関連宣言届ID` 列がSharePointリストで「数値」型の場合はそのまま使用。「1行テキスト」型の場合は `Text(Dropdown1.Selected.ID)` に変更してください。

---

## 9. Power Automate 具体的な修正手順

> ⚠️ Phase 0 の追加調査（条件1 False分岐の展開確認）を先に行ってください。

### 修正2-1: 遅延の追加

1. フロー編集画面を開く
2. 「項目が作成されたとき」と「項目の更新 2」の間の **「＋」ボタン** をクリック
3. 「アクションの追加」を選択
4. 検索欄に「遅延」と入力
5. 「遅延」（Schedule）を選択
6. 設定：

| 設定 | 値 |
|------|-----|
| カウント | `10` |
| 単位 | `秒` |

---

### 修正2-2: 条件1 False分岐の確認・修正

#### パターンA：条件2が既にある場合
→ Teams通知の内容がGitHub仕様と一致しているか確認し、必要に応じて修正

#### パターンB：条件2がない場合 → 以下を追加

**Step 1: 条件1のFalse分岐内に「条件」を追加**

1. 条件1の「False」分岐内の「＋」をクリック
2. 「アクションの追加」→「条件」を選択
3. 条件を設定：

| 設定 | 値 |
|------|-----|
| 左辺 | 動的コンテンツ: `事前ボーナス`（項目の更新 2セクションから） |
| 演算子 | `次の値より大きい` |
| 右辺 | `0` |

**Step 2: 条件2 True（ボーナスあり）→ 項目の更新 + Teams通知**

項目の更新を追加：

| 設定 | 値 |
|------|-----|
| サイト | 同じSharePointサイト |
| リスト名 | `資格取得申請` |
| ID | 動的コンテンツ: `body/ID`（項目の更新 2から） |
| ステータス Value | `承認済` |
| 承認者 Claims | 動的コンテンツ: 応答者のユーザープリンシパル名 |
| 承認日 | 式: `utcNow()` |

Teams通知を追加（パターン2）：

| 設定 | 値 |
|------|-----|
| 投稿者 | `フローボット` |
| 投稿先 | `フローボットとチャットをする` |
| Recipient | 動的コンテンツ: `申請者 Email`（項目の更新 2から） |

メッセージ内容：
```
🎉 資格取得届が承認されました

━━━━━━━━━━━━━━━━━━━━━
■ 申請者: 【動的コンテンツ: 登録者 DisplayName】
■ 資格名: 【動的コンテンツ: タイトル】
■ 取得日: 【動的コンテンツ: 予定日_取得日】
━━━━━━━━━━━━━━━━━━━━━

【報奨金内訳】
【動的コンテンツ: 作成 の出力（本文）】

おめでとうございます！🎊
```

**Step 3: 条件2 False（ボーナスなし）→ 項目の更新 + Teams通知**

項目の更新：Step 2と同じ設定

Teams通知メッセージ内容（パターン3）：
```
🎉 資格取得届が承認されました

━━━━━━━━━━━━━━━━━━━━━
■ 申請者: 【動的コンテンツ: 登録者 DisplayName】
■ 資格名: 【動的コンテンツ: タイトル】
■ 取得日: 【動的コンテンツ: 予定日_取得日】
━━━━━━━━━━━━━━━━━━━━━

【報奨金】
【動的コンテンツ: 作成 の出力（本文）】

おめでとうございます！🎊

💡 次回は事前に「資格取得宣言届」を提出すると
   ¥5,000のボーナスが加算されます。
```

---

### 修正2-3: 承認タイトルに資格名を追加（任意）

| 項目 | 値 |
|------|-----|
| 現在 | `【資格取得申請】承認依頼` |
| 修正後 | `【資格取得申請】承認依頼: ` + 動的コンテンツ「タイトル」 |

---

### 修正後の完成フロー構造

```
1. 項目が作成されたとき（トリガー）
   │
2. └─ 遅延（10秒）                              ← 追加
      │
3.    └─ 項目の更新 2（データセット）              ← 既存のまま
         │
4.       └─ 作成（報奨金表示テキスト）            ← 既存のまま
            │
5.          └─ 開始して承認を待機                 ← タイトルに資格名追加（任意）
               │
6.             └─ 条件（body/outcome = Approve）
                  │
                  ├─ True（承認）
                  │   └─ 条件1（申請種別 = 宣言届？）
                  │       │
                  │       ├─ True（宣言届）
                  │       │   ├─ Teams通知2（宣言届承認）       ← 既存のまま
                  │       │   └─ For each → 項目の更新（承認済） ← 既存のまま
                  │       │
                  │       └─ False（取得届）
                  │           └─ 条件2（事前ボーナス > 0？）      ← 要確認/追加
                  │               │
                  │               ├─ True（ボーナスあり）
                  │               │   ├─ 項目の更新（承認済）     ← 要確認/追加
                  │               │   └─ Teams通知（パターン2）   ← 要確認/追加
                  │               │
                  │               └─ False（ボーナスなし）
                  │                   ├─ 項目の更新（承認済）     ← 要確認/追加
                  │                   └─ Teams通知（パターン3）   ← 要確認/追加
                  │
                  └─ False（却下）
                      ├─ 項目の更新 1（却下）                    ← 既存のまま
                      ├─ Teams通知1（却下）                      ← 既存のまま
                      └─ （For each 1 → 項目の更新 4）           ← 要確認
```

---

## 10. テスト計画

### テストシナリオ

| No. | テスト内容 | 期待結果 | 確認 |
|-----|----------|---------|------|
| 1 | 宣言届を申請 → 承認 | ステータス「承認済」、Teams通知に金額表示なし | □ |
| 2 | 取得届（宣言届を紐づけ）→ 承認 | 報奨金 + ¥5,000表示、関連宣言届IDが記録される | □ |
| 3 | 取得届（宣言届なし）→ 承認 | 報奨金のみ表示、ボーナス案内メッセージ | □ |
| 4 | 申請を却下 | ステータス「却下」、却下理由付きTeams通知 | □ |
| 5 | SharePointリスト確認 | 承認者・承認日が正しく記録されている | □ |

### テスト手順

1. **テスト1（宣言届）:**
   - Power Appsで「資格取得宣言届」を選択
   - 適当な資格を選択して申請
   - Power Automate承認センターで承認
   - Teams通知の内容を確認

2. **テスト2（取得届＋宣言届あり）:**
   - Power Appsで「資格取得届」を選択
   - テスト1と同じ資格を選択
   - 「過去の宣言届出」ドロップダウンでテスト1の宣言届を選択
   - 申請して承認
   - Teams通知に報奨金 + ¥5,000が表示されることを確認
   - SharePointリストで関連宣言届IDが記録されていることを確認

3. **テスト3（取得届＋宣言届なし）:**
   - Power Appsで「資格取得届」を選択
   - 宣言届を出していない資格を選択
   - 「過去の宣言届出」は選択せず申請
   - 承認後のTeams通知を確認

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-09 | 差分調査・現状分析・修正プラン作成 |
