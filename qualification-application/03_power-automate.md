# Power Automate 承認フロー 設計・作成手順

## 1. フロー作成

### 1.1 Power Automateにアクセス
1. https://make.powerautomate.com にアクセス
2. 左メニュー「+ 作成」
3. 「自動化したクラウドフロー」を選択
4. フロー名: `資格取得申請_承認フロー`
5. トリガー検索: `SharePoint 項目が作成されたとき`
6. 「作成」

---

## 2. トリガー設定

### 2.1 SharePointトリガー
```
トリガー: 項目が作成されたとき (SharePoint)

設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
```

---

## 3. 承認アクション

### 3.1 承認を開始して待機
1. 「+ 新しいステップ」
2. 「承認」コネクタを検索
3. 「開始して承認を待機」を選択

### 3.2 承認の設定
```
承認の種類: 承認/拒否 - 最初に応答

タイトル:
資格取得申請 - @{triggerOutputs()?['body/申請種別/Value']}

担当者:
[承認者のメールアドレス]
※複数可: user1@company.com;user2@company.com

詳細:
■ 申請者: @{triggerOutputs()?['body/申請者/DisplayName']}
■ 申請種別: @{triggerOutputs()?['body/申請種別/Value']}
■ 取得資格: @{triggerOutputs()?['body/取得資格/Value']}
■ 予定日/取得日: @{formatDateTime(triggerOutputs()?['body/予定日_取得日'], 'yyyy/MM/dd')}
■ 理由/内容: @{triggerOutputs()?['body/理由_内容']}
■ 報奨金: ¥@{triggerOutputs()?['body/報奨金額']}
■ 事前申請ボーナス: ¥@{triggerOutputs()?['body/事前ボーナス']}
─────────────────
合計: ¥@{add(triggerOutputs()?['body/報奨金額'], triggerOutputs()?['body/事前ボーナス'])}

アイテムリンク:
@{triggerOutputs()?['body/{Link}']}
```

---

## 4. 条件分岐（承認結果）

### 4.1 条件追加
1. 「+ 新しいステップ」
2. 「条件」コントロールを選択

### 4.2 条件設定
```
条件:
outputs('開始して承認を待機')?['body/outcome']  次の値に等しい  Approve
```

---

## 5. 承認された場合（はいの場合）

### 5.1 SharePointリスト更新
1. 「はいの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: @{triggerOutputs()?['body/ID']}
- ステータス Value: 承認済
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 5.2 Teams通知（申請者へ）- 承認
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: Chat with Flow bot
- 受信者: @{triggerOutputs()?['body/申請者/Email']}
- メッセージ:
```

**メッセージ内容:**
```html
<b>✅ 資格取得申請が承認されました</b>

<b>申請内容:</b>
・種別: @{triggerOutputs()?['body/申請種別/Value']}
・資格: @{triggerOutputs()?['body/取得資格/Value']}
・報奨金: ¥@{add(triggerOutputs()?['body/報奨金額'], triggerOutputs()?['body/事前ボーナス'])}

<b>承認者:</b> @{outputs('開始して承認を待機')?['body/responses'][0]['responder']['displayName']}
<b>承認日時:</b> @{formatDateTime(utcNow(), 'yyyy/MM/dd HH:mm')}

資格取得頑張ってください！
```

---

## 6. 却下された場合（いいえの場合）

### 6.1 SharePointリスト更新
1. 「いいえの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: @{triggerOutputs()?['body/ID']}
- ステータス Value: 却下
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 6.2 Teams通知（申請者へ）- 却下
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: Chat with Flow bot
- 受信者: @{triggerOutputs()?['body/申請者/Email']}
- メッセージ:
```

**メッセージ内容:**
```html
<b>❌ 資格取得申請が却下されました</b>

<b>申請内容:</b>
・種別: @{triggerOutputs()?['body/申請種別/Value']}
・資格: @{triggerOutputs()?['body/取得資格/Value']}

<b>却下者:</b> @{outputs('開始して承認を待機')?['body/responses'][0]['responder']['displayName']}
<b>コメント:</b> @{outputs('開始して承認を待機')?['body/responses'][0]['comments']}

ご不明点があれば、承認者にお問い合わせください。
```

---

## 7. フロー全体図

```
┌─────────────────────────────────────────────────┐
│ トリガー: 項目が作成されたとき (SharePoint)       │
│           リスト: 資格取得申請                   │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 開始して承認を待機                               │
│ - 承認者に通知（Teamsカード）                    │
│ - 承認/却下を待つ                               │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 条件: outcome = Approve ?                       │
└─────────────────────────────────────────────────┘
          ↓ はい              ↓ いいえ
┌──────────────────┐   ┌──────────────────┐
│ リスト更新        │   │ リスト更新        │
│ ステータス=承認済  │   │ ステータス=却下   │
└──────────────────┘   └──────────────────┘
          ↓                      ↓
┌──────────────────┐   ┌──────────────────┐
│ Teams通知        │   │ Teams通知        │
│ 「承認されました」 │   │ 「却下されました」 │
└──────────────────┘   └──────────────────┘
```

---

## 8. フローの保存とテスト

### 8.1 保存
1. 右上「保存」をクリック

### 8.2 テスト
1. 右上「テスト」をクリック
2. 「手動」を選択
3. 「テスト」をクリック
4. Power Appsから申請を実行
5. 承認者のTeamsで承認カードを確認
6. 承認/却下を実行
7. 申請者への通知を確認
8. SharePointリストのステータス更新を確認

---

## 9. 詳細設定（オプション）

### 9.1 並列承認（複数承認者）
承認の種類を変更:
```
承認の種類: 承認/拒否 - 全員が承認する必要があります
```

### 9.2 期限設定
承認アクションの詳細オプション:
```
期限: @{addDays(utcNow(), 7)}
```

### 9.3 リマインダー
期限前にリマインダーを送信:
```
スケジュール済みリマインダー: 有効
リマインダー頻度: 毎日
```

### 9.4 エスカレーション
期限切れ時の処理:
```
エスカレーション有効: はい
エスカレーション先: [上位承認者のメール]
```

---

## 10. トラブルシューティング

| 問題 | 解決方法 |
|------|---------|
| フローが起動しない | SharePointリストとの接続を確認、トリガー条件を確認 |
| 承認カードが届かない | 承認者のメールアドレスを確認、Teamsアプリの通知設定を確認 |
| リスト更新エラー | 列名の一致を確認、Value形式の指定を確認 |
| 通知が届かない | 受信者のメールアドレス形式を確認 |

---

## 11. 運用開始後のモニタリング

### 11.1 実行履歴の確認
1. Power Automate → マイフロー
2. フローを選択 → 「実行履歴」
3. 失敗した実行があれば詳細を確認

### 11.2 アラート設定
1. フローの「...」→「設定」
2. 「このフローが失敗した場合」→ 通知先を設定
