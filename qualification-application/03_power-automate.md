# Power Automate 承認フロー 設計・作成手順

## 1. フロー作成

### 1.1 Power Automateにアクセス
1. https://make.powerautomate.com にアクセス
2. 左メニュー「+ 作成」
3. 「自動化したクラウドフロー」を選択
4. フロー名: `資格取得申請_承認フロー`
5. トリガー検索: `SharePoint 項目が作成されたとき`
6. 「作成」

---

## 2. トリガー設定

### 2.1 SharePointトリガー
```
トリガー: 項目が作成されたとき (SharePoint)

設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
```

---

## 3. 遅延アクション（重要）

### 3.1 遅延を追加
トリガーの直後に遅延アクションを追加します。これはSharePointがアイテムを完全に保存するのを待つためです。

```
アクション: 遅延
設定:
- 期間: 10
- 単位: 秒
```

> **重要**: この遅延がないと「Could not find list item」エラーが発生する可能性があります。

---

## 4. 項目の更新アクション

### 4.1 項目の更新を追加
遅延の後に「項目の更新」アクションを追加します。このアクションの出力を後続のアクションで使用します。

```
アクション: 項目の更新 (SharePoint)

設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID を選択]
- タイトル: [トリガーから タイトル を選択]
- 申請者 Claims: [トリガーから 登録者 Email を選択]
- ステータス Value: 申請中
- 報奨金額: [トリガーから 報奨金額 を選択]
- 事前ボーナス: [トリガーから 事前ボーナス を選択]
```

> **重要**: 報奨金額と事前ボーナスを必ず含めてください。後続の式で参照するために必要です。

---

## 5. 報奨金表示用の作成アクション

### 5.1 作成（Compose）アクションを追加
「項目の更新」の後に「作成」アクションを追加します。これは報奨金の表示文字列を生成するためです。

```
アクション: 作成 (データ操作)

入力:（式として入力）
```

### 5.2 報奨金表示の式（4パターン対応）

以下の式を「作成」アクションの入力に設定します：

```
if(equals(outputs('項目の更新_2')?['body/OData__x5831__x5968__x91d1__x984d_'],0),if(greater(outputs('項目の更新_2')?['body/OData__x4e8b__x524d__x30dc__x30fc__x30'],0),'5,000円（事前申請ボーナス）+ 受験料相当額','受験料相当額'),if(greater(outputs('項目の更新_2')?['body/OData__x4e8b__x524d__x30dc__x30fc__x30'],0),concat(string(outputs('項目の更新_2')?['body/OData__x5831__x5968__x91d1__x984d_']),'円 + 5,000円（事前申請ボーナス）'),concat(string(outputs('項目の更新_2')?['body/OData__x5831__x5968__x91d1__x984d_']),'円')))
```

> **注意**: SharePointの日本語列名は内部名が異なります。
> - 報奨金額 → `OData__x5831__x5968__x91d1__x984d_`
> - 事前ボーナス → `OData__x4e8b__x524d__x30dc__x30fc__x30`
>
> 環境によって内部名が異なる場合があります。動的コンテンツから直接選択してコードビューで確認してください。

### 5.3 表示パターン一覧

| 報奨金 | 申請種別 | 表示 |
|--------|---------|------|
| 0円（FP3級など） | 資格取得宣言届 | 5,000円（事前申請ボーナス）+ 受験料相当額 |
| 0円（FP3級など） | 資格取得届 | 受験料相当額 |
| 通常 | 資格取得宣言届 | [金額]円 + 5,000円（事前申請ボーナス） |
| 通常 | 資格取得届 | [金額]円 |

---

## 6. 承認アクション

### 6.1 承認を開始して待機
1. 「+ 新しいステップ」
2. 「承認」コネクタを検索
3. 「開始して承認を待機」を選択

### 6.2 承認の設定
```
承認の種類: 承認/拒否 - 最初に応答

タイトル:
【資格取得申請】承認依頼

担当者:
[承認者のメールアドレス]
※複数可: user1@company.com;user2@company.com

詳細:
申請者：[項目の更新 2 → 登録者 DisplayName]
資格名：[項目の更新 2 → タイトル]
取得予定日：[項目の更新 2 → 予定日_取得日]
理由：[項目の更新 2 → 理由_内容]
報奨金額：[作成 → 出力]    ← 作成アクションの出力を使用
```

> **重要**: 報奨金額には「作成」アクションの「出力」を動的コンテンツから選択してください。

---

## 7. 条件分岐（承認結果）

### 7.1 条件追加
1. 「+ 新しいステップ」
2. 「条件」コントロールを選択

### 7.2 条件設定
```
条件:
outputs('開始して承認を待機')?['body/outcome']  次の値に等しい  Approve
```

---

## 8. 承認された場合（はいの場合）

### 8.1 SharePointリスト更新
1. 「はいの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID]
- ステータス Value: 承認済
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 8.2 Teams通知（申請者へ）- 承認
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: フロー ボットとチャットする
- 受信者: [項目の更新 2 → 登録者 Email]
- メッセージ:
```

**メッセージ内容:**
```
✅【承認されました】資格取得申請
あなたの資格取得申請が承認されました。

■ 資格名：[項目の更新 2 → タイトル]
■ 報奨金額：[作成 → 出力]

おめでとうございます！
```

---

## 9. 却下された場合（いいえの場合）

### 9.1 SharePointリスト更新
1. 「いいえの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID]
- ステータス Value: 却下
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 9.2 Teams通知（申請者へ）- 却下
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: フロー ボットとチャットする
- 受信者: [項目の更新 2 → 登録者 Email]
- メッセージ:
```

**メッセージ内容:**
```
❌【却下されました】資格取得申請
資格取得申請が却下されました。

■ 資格名：[項目の更新 2 → タイトル]
■ 却下者：[承認のレスポンス → responder displayName]
■ コメント：[承認のレスポンス → comments]

ご不明点があれば、承認者にお問い合わせください。
```

---

## 10. フロー全体図

```
┌─────────────────────────────────────────────────┐
│ トリガー: 項目が作成されたとき (SharePoint)       │
│           リスト: 資格取得申請                   │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 遅延: 10秒                                       │
│ ※SharePointの保存完了を待つ                     │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 項目の更新 2                                     │
│ - タイトル、申請者、ステータス                    │
│ - 報奨金額、事前ボーナス ←重要                   │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 作成（Compose）                                  │
│ - 報奨金表示文字列を生成（4パターン分岐）         │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 開始して承認を待機                               │
│ - 承認者に通知（詳細に作成の出力を使用）          │
│ - 承認/却下を待つ                               │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 条件: outcome = Approve ?                       │
└─────────────────────────────────────────────────┘
          ↓ はい              ↓ いいえ
┌──────────────────┐   ┌──────────────────┐
│ リスト更新        │   │ リスト更新        │
│ ステータス=承認済  │   │ ステータス=却下   │
└──────────────────┘   └──────────────────┘
          ↓                      ↓
┌──────────────────┐   ┌──────────────────┐
│ Teams通知        │   │ Teams通知        │
│ 「承認されました」 │   │ 「却下されました」 │
│ ※作成の出力を使用 │   │                  │
└──────────────────┘   └──────────────────┘
```

---

## 11. フローの保存とテスト

### 11.1 保存
1. 右上「保存」をクリック

### 11.2 テスト
1. 右上「テスト」をクリック
2. 「手動」を選択
3. 「テスト」をクリック
4. Power Appsから申請を実行
5. 承認者のTeamsで承認カードを確認
6. 承認/却下を実行
7. 申請者への通知を確認
8. SharePointリストのステータス更新を確認

### 11.3 テストケース

| テスト内容 | 申請内容 | 期待する表示 |
|-----------|---------|------------|
| FP3級 + 宣言届 | 報奨金0円、事前ボーナス5000円 | 5,000円（事前申請ボーナス）+ 受験料相当額 |
| FP3級 + 取得届 | 報奨金0円、事前ボーナス0円 | 受験料相当額 |
| 日商簿記2級 + 宣言届 | 報奨金10000円、事前ボーナス5000円 | 10000円 + 5,000円（事前申請ボーナス） |
| 日商簿記2級 + 取得届 | 報奨金10000円、事前ボーナス0円 | 10000円 |

---

## 12. 詳細設定（オプション）

### 12.1 並列承認（複数承認者）
承認の種類を変更:
```
承認の種類: 承認/拒否 - 全員が承認する必要があります
```

### 12.2 期限設定
承認アクションの詳細オプション:
```
期限: @{addDays(utcNow(), 7)}
```

### 12.3 リマインダー
期限前にリマインダーを送信:
```
スケジュール済みリマインダー: 有効
リマインダー頻度: 毎日
```

---

## 13. トラブルシューティング

| 問題 | 解決方法 |
|------|---------|
| フローが起動しない | SharePointリストとの接続を確認、トリガー条件を確認 |
| 「Could not find list item」エラー | 遅延アクションを追加（10秒以上） |
| 報奨金が空/0と表示される | 「項目の更新 2」に報奨金額と事前ボーナスを含める |
| 式でエラー | 列の内部名を確認（動的コンテンツ→コードビューで確認） |
| 承認カードが届かない | 承認者のメールアドレスを確認、Teamsアプリの通知設定を確認 |
| リスト更新エラー | 列名の一致を確認、Value形式の指定を確認 |
| 通知が届かない | 受信者のメールアドレス形式を確認 |

### 内部列名の確認方法
1. 「作成」アクションで動的コンテンツから列を選択
2. 「コードビュー」タブをクリック
3. `outputs('アクション名')?['body/列名']` の形式で内部名を確認

---

## 14. 運用開始後のモニタリング

### 14.1 実行履歴の確認
1. Power Automate → マイフロー
2. フローを選択 → 「実行履歴」
3. 失敗した実行があれば詳細を確認

### 14.2 アラート設定
1. フローの「...」→「設定」
2. 「このフローが失敗した場合」→ 通知先を設定
