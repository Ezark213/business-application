# Power Automate 承認フロー 設計・作成手順

## 1. フロー作成

### 1.1 Power Automateにアクセス
1. https://make.powerautomate.com にアクセス
2. 左メニュー「+ 作成」
3. 「自動化したクラウドフロー」を選択
4. フロー名: `資格取得申請_承認フロー`
5. トリガー検索: `SharePoint 項目が作成されたとき`
6. 「作成」

---

## 2. 報奨金の仕組み（重要）

### 2.1 支払いルール

| 申請種別 | 報奨金 | 事前ボーナス | 通知メッセージ |
|---------|-------|------------|--------------|
| 資格取得宣言届 | 0円 | 0円 | ※報奨金は資格取得後の届出時に確定します |
| 資格取得届（宣言届あり） | 報奨金額 | +5,000円 | [金額]円 + 5,000円（事前申請ボーナス） |
| 資格取得届（宣言届なし） | 報奨金額 | 0円 | [金額]円 |

> **重要**: 宣言届の時点では報奨金は支払われません。実際の報奨金は資格取得後の「取得届」提出時に確定します。

---

## 3. トリガー設定

### 3.1 SharePointトリガー
```
トリガー: 項目が作成されたとき (SharePoint)

設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
```

---

## 4. 遅延アクション（重要）

### 4.1 遅延を追加
トリガーの直後に遅延アクションを追加します。これはSharePointがアイテムを完全に保存するのを待つためです。

```
アクション: 遅延
設定:
- 期間: 10
- 単位: 秒
```

> **重要**: この遅延がないと「Could not find list item」エラーが発生する可能性があります。

---

## 5. 項目の取得アクション

### 5.1 項目の取得を追加
遅延の後に「項目の取得」アクションを追加します。このアクションの出力を後続のアクションで使用します。

```
アクション: 項目の取得 (SharePoint)

設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID を選択]
```

> **注意**: 「項目の更新」ではなく「項目の取得」を使用することで、404エラーを回避できます。

---

## 6. 報奨金表示用の作成アクション

### 6.1 作成（Compose）アクションを追加
「項目の取得」の後に「作成」アクションを追加します。これは報奨金の表示文字列を生成するためです。

```
アクション: 作成 (データ操作)

入力:（式として入力）
```

### 6.2 報奨金表示の式（3パターン対応）

以下の式を「作成」アクションの入力に設定します：

```
if(
    contains(string(outputs('項目の取得')?['body']), '宣言届'),
    '※報奨金は資格取得後の届出時に確定します',
    if(
      equals(coalesce(outputs('項目の取得')?['body/OData__x5831__x5968__x91d1__x984d_'], 0), 0),
      if(
        greater(coalesce(outputs('項目の取得')?['body/OData__x4e8b__x524d__x30dc__x30fc__x30ca__x30b9_'], 0), 0),
        '受験料相当額 + 5,000円（事前申請ボーナス）',
        '受験料相当額'
      ),
      if(
        greater(coalesce(outputs('項目の取得')?['body/OData__x4e8b__x524d__x30dc__x30fc__x30ca__x30b9_'], 0), 0),
        concat(string(outputs('項目の取得')?['body/OData__x5831__x5968__x91d1__x984d_']), '円 + 5,000円（事前申請ボーナス）'),
        concat(string(outputs('項目の取得')?['body/OData__x5831__x5968__x91d1__x984d_']), '円')
      )
    )
)
```

> **注意**: SharePointの日本語列名は内部名が異なります。
> - 報奨金額 → `OData__x5831__x5968__x91d1__x984d_`
> - 事前ボーナス → `OData__x4e8b__x524d__x30dc__x30fc__x30ca__x30b9_`
>
> 環境によって内部名が異なる場合があります。動的コンテンツから直接選択してコードビューで確認してください。

### 6.3 coalesce関数について

`coalesce()` 関数は、Null値を処理するために使用します。

```
coalesce(値, デフォルト値)
```

- 値がNullの場合、デフォルト値（この場合は0）を返します
- 値がNullでない場合、その値をそのまま返します

> **重要**: `greater()` 関数にNullを渡すとエラーになるため、`coalesce()` でラップする必要があります。

### 6.4 表示パターン一覧

| 申請種別 | 報奨金 | 事前ボーナス | 表示 |
|---------|-------|------------|------|
| 資格取得宣言届 | 0円 | 0円 | ※報奨金は資格取得後の届出時に確定します |
| 資格取得届 | 0円 | 0円 | 受験料相当額 |
| 資格取得届 | 0円 | 5000円 | 受験料相当額 + 5,000円（事前申請ボーナス） |
| 資格取得届 | 通常 | 0円 | [金額]円 |
| 資格取得届 | 通常 | 5000円 | [金額]円 + 5,000円（事前申請ボーナス） |

---

## 7. 承認アクション

### 7.1 承認を開始して待機
1. 「+ 新しいステップ」
2. 「承認」コネクタを検索
3. 「開始して承認を待機」を選択

### 7.2 承認の設定
```
承認の種類: 承認/拒否 - 最初に応答

タイトル:
【資格取得申請】承認依頼

担当者:
[承認者のメールアドレス]
※複数可: user1@company.com;user2@company.com

詳細:
申請者：[項目の取得 → 登録者 DisplayName]
資格名：[項目の取得 → タイトル]
取得予定日：[項目の取得 → 予定日_取得日]
理由：[項目の取得 → 理由_内容]
報奨金額：[作成 → 出力]    ← 作成アクションの出力を使用
```

> **重要**: 報奨金額には「作成」アクションの「出力」を動的コンテンツから選択してください。

---

## 8. 条件分岐（承認結果）

### 8.1 条件追加
1. 「+ 新しいステップ」
2. 「条件」コントロールを選択

### 8.2 条件設定
```
条件:
outputs('開始して承認を待機')?['body/outcome']  次の値に等しい  Approve
```

---

## 9. 承認された場合（はいの場合）

### 9.1 SharePointリスト更新
1. 「はいの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID]
- ステータス Value: 承認済
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 9.2 Teams通知（申請者へ）- 承認
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: フロー ボットとチャットする
- 受信者: [項目の取得 → 登録者 Email]
- メッセージ:
```

**メッセージ内容:**
```
【承認されました】資格取得申請
あなたの資格取得申請が承認されました。

■ 資格名：[項目の取得 → タイトル]
■ 報奨金額：[作成 → 出力]

おめでとうございます！
```

---

## 10. 却下された場合（いいえの場合）

### 10.1 SharePointリスト更新
1. 「いいえの場合」内に「項目の更新」(SharePoint)を追加

```
設定:
- サイトのアドレス: [SharePointサイトURL]
- リスト名: 資格取得申請
- ID: [トリガーから ID]
- ステータス Value: 却下
- 承認者 Claims: i:0#.f|membership|@{outputs('開始して承認を待機')?['body/responses'][0]['responder']['email']}
- 承認日: @{utcNow()}
```

### 10.2 Teams通知（申請者へ）- 却下
1. 「チャットまたはチャネルにメッセージを投稿する」(Microsoft Teams)を追加

```
設定:
- 投稿者: フローボット
- 投稿先: フロー ボットとチャットする
- 受信者: [項目の取得 → 登録者 Email]
- メッセージ:
```

**メッセージ内容:**
```
【却下されました】資格取得申請
資格取得申請が却下されました。

■ 資格名：[項目の取得 → タイトル]
■ 却下者：[承認のレスポンス → responder displayName]
■ コメント：[承認のレスポンス → comments]

ご不明点があれば、承認者にお問い合わせください。
```

---

## 11. フロー全体図

```
┌─────────────────────────────────────────────────┐
│ トリガー: 項目が作成されたとき (SharePoint)       │
│           リスト: 資格取得申請                   │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 遅延: 10秒                                       │
│ ※SharePointの保存完了を待つ                     │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 項目の取得                                       │
│ - ID指定で項目を取得                             │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 作成（Compose）                                  │
│ - 報奨金表示文字列を生成（3パターン分岐）         │
│ - 宣言届: ※報奨金は資格取得後の届出時に確定      │
│ - 取得届（ボーナスあり）: XX円 + 5,000円         │
│ - 取得届（ボーナスなし）: XX円                   │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 開始して承認を待機                               │
│ - 承認者に通知（詳細に作成の出力を使用）          │
│ - 承認/却下を待つ                               │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│ 条件: outcome = Approve ?                       │
└─────────────────────────────────────────────────┘
          ↓ はい              ↓ いいえ
┌──────────────────┐   ┌──────────────────┐
│ リスト更新        │   │ リスト更新        │
│ ステータス=承認済  │   │ ステータス=却下   │
└──────────────────┘   └──────────────────┘
          ↓                      ↓
┌──────────────────┐   ┌──────────────────┐
│ Teams通知        │   │ Teams通知        │
│ 「承認されました」 │   │ 「却下されました」 │
│ ※作成の出力を使用 │   │                  │
└──────────────────┘   └──────────────────┘
```

---

## 12. フローの保存とテスト

### 12.1 保存
1. 右上「保存」をクリック

### 12.2 テスト
1. 右上「テスト」をクリック
2. 「手動」を選択
3. 「テスト」をクリック
4. Power Appsから申請を実行
5. 承認者のTeamsで承認カードを確認
6. 承認/却下を実行
7. 申請者への通知を確認
8. SharePointリストのステータス更新を確認

### 12.3 テストケース

| テスト内容 | 申請内容 | 期待する表示 |
|-----------|---------|------------|
| FP3級 + 宣言届 | 報奨金0円、事前ボーナス0円 | ※報奨金は資格取得後の届出時に確定します |
| FP3級 + 取得届（宣言なし） | 報奨金0円、事前ボーナス0円 | 受験料相当額 |
| FP3級 + 取得届（宣言あり） | 報奨金0円、事前ボーナス5000円 | 受験料相当額 + 5,000円（事前申請ボーナス） |
| 日商簿記2級 + 宣言届 | 報奨金0円、事前ボーナス0円 | ※報奨金は資格取得後の届出時に確定します |
| 日商簿記2級 + 取得届（宣言なし） | 報奨金10000円、事前ボーナス0円 | 10000円 |
| 日商簿記2級 + 取得届（宣言あり） | 報奨金10000円、事前ボーナス5000円 | 10000円 + 5,000円（事前申請ボーナス） |

---

## 13. 詳細設定（オプション）

### 13.1 並列承認（複数承認者）
承認の種類を変更:
```
承認の種類: 承認/拒否 - 全員が承認する必要があります
```

### 13.2 期限設定
承認アクションの詳細オプション:
```
期限: @{addDays(utcNow(), 7)}
```

### 13.3 リマインダー
期限前にリマインダーを送信:
```
スケジュール済みリマインダー: 有効
リマインダー頻度: 毎日
```

---

## 14. トラブルシューティング

| 問題 | 解決方法 |
|------|---------|
| フローが起動しない | SharePointリストとの接続を確認、トリガー条件を確認 |
| 「Could not find list item」エラー | 遅延アクションを追加（10秒以上）、項目の取得を使用 |
| 「greater function parameter is null」エラー | coalesce()関数で値をラップする |
| 報奨金が空/0と表示される | 式の列名を確認、coalesce()でNull対策 |
| 式でエラー | 列の内部名を確認（動的コンテンツ→コードビューで確認） |
| 承認カードが届かない | 承認者のメールアドレスを確認、Teamsアプリの通知設定を確認 |
| リスト更新エラー | 列名の一致を確認、Value形式の指定を確認 |
| 通知が届かない | 受信者のメールアドレス形式を確認 |

### 内部列名の確認方法
1. 「作成」アクションで動的コンテンツから列を選択
2. 「コードビュー」タブをクリック
3. `outputs('アクション名')?['body/列名']` の形式で内部名を確認

---

## 15. 運用開始後のモニタリング

### 15.1 実行履歴の確認
1. Power Automate → マイフロー
2. フローを選択 → 「実行履歴」
3. 失敗した実行があれば詳細を確認

### 15.2 アラート設定
1. フローの「...」→「設定」
2. 「このフローが失敗した場合」→ 通知先を設定
