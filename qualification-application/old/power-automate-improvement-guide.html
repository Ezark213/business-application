<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Automate 改良ガイド - 報奨金表示の条件分岐</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            line-height: 1.8;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #0066bf;
            border-bottom: 3px solid #0066bf;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        h2 {
            color: #0066bf;
            margin-top: 40px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #e6f2ff;
            border-left: 5px solid #0066bf;
            font-size: 1.3em;
        }

        h3 {
            color: #444;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        p {
            margin-bottom: 15px;
        }

        .overview {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .overview h3 {
            color: #f57c00;
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #0066bf;
            color: white;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .step {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .step-number {
            display: inline-block;
            background: #0066bf;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        ol, ul {
            margin: 15px 0 15px 30px;
        }

        li {
            margin-bottom: 10px;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .code-inline {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        .explanation {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .explanation h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .before-after {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .before-box, .after-box {
            flex: 1;
            min-width: 300px;
            border-radius: 8px;
            overflow: hidden;
        }

        .before-box {
            border: 2px solid #f44336;
        }

        .after-box {
            border: 2px solid #4caf50;
        }

        .before-box .label, .after-box .label {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: white;
        }

        .before-box .label {
            background: #f44336;
        }

        .after-box .label {
            background: #4caf50;
        }

        .before-box .content, .after-box .content {
            padding: 15px;
            background: #fafafa;
        }

        .copy-hint {
            background: #e8f5e9;
            border: 1px dashed #4caf50;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .copy-hint::before {
            content: "📋 ";
        }

        .teams-preview {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .teams-message {
            background: white;
            border-left: 4px solid #6264a7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .teams-message .title {
            color: #6264a7;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .check-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            margin: 5px 0;
            border-radius: 5px;
        }

        .check-item::before {
            content: "✓";
            color: #4caf50;
            font-weight: bold;
            margin-right: 10px;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .highlight {
            background: #fff9c4;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Power Automate 改良ガイド<br>報奨金表示の条件分岐</h1>

        <div class="overview">
            <h3>この改良の目的</h3>
            <p>Teams通知に表示される報奨金を、申請種別と報奨金額に応じて適切に表示するように変更します。</p>
            <p><strong>特に、FP3級のように報奨金が0円の資格の場合に「受験料相当額」と表示</strong>されるようにします。</p>
        </div>

        <!-- 表示パターン -->
        <h2>表示パターン一覧</h2>

        <table>
            <thead>
                <tr>
                    <th>報奨金</th>
                    <th>申請種別</th>
                    <th>Teams通知での表示</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>0円（FP3級など）</td>
                    <td>資格取得宣言届</td>
                    <td><strong>¥5,000（事前申請ボーナス）+ 受験料相当額</strong></td>
                </tr>
                <tr>
                    <td>0円（FP3級など）</td>
                    <td>資格取得届</td>
                    <td><strong>受験料相当額</strong></td>
                </tr>
                <tr>
                    <td>通常（10,000円など）</td>
                    <td>資格取得宣言届</td>
                    <td><strong>¥10,000 + ¥5,000（事前申請ボーナス）</strong></td>
                </tr>
                <tr>
                    <td>通常（10,000円など）</td>
                    <td>資格取得届</td>
                    <td><strong>¥10,000</strong></td>
                </tr>
            </tbody>
        </table>

        <!-- Teams通知プレビュー -->
        <h3>Teams通知のイメージ</h3>
        <div class="teams-preview">
            <div class="teams-message">
                <div class="title">✅ 資格取得申請が承認されました</div>
                <p><strong>申請種別：</strong>資格取得宣言届</p>
                <p><strong>資格：</strong>ファイナンシャル・プランニング技能検定 3級</p>
                <p><strong>報奨金：</strong><span class="highlight">¥5,000（事前申請ボーナス）+ 受験料相当額</span></p>
                <p><strong>承認者：</strong>山田太郎</p>
            </div>
        </div>

        <!-- Step 1 -->
        <h2>Step 1: Power Automateを開く</h2>

        <div class="step">
            <h3><span class="step-number">1</span>Power Automateにアクセス</h3>
            <ol>
                <li>ブラウザで <a href="https://make.powerautomate.com" target="_blank">https://make.powerautomate.com</a> を開く</li>
                <li>Microsoft 365 アカウントでサインイン</li>
            </ol>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>フローを探す</h3>
            <ol>
                <li>左メニューから <strong>「マイ フロー」</strong> をクリック</li>
                <li>一覧から <strong>「資格取得申請_承認フロー」</strong> を探す</li>
                <li>フロー名をクリックして詳細を開く</li>
            </ol>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span>編集モードに入る</h3>
            <ol>
                <li>画面上部の <strong>「編集」</strong> ボタンをクリック</li>
                <li>フローの編集画面が表示される</li>
            </ol>

            <div class="warning">
                <strong>注意</strong><br>
                編集前に「名前を付けて保存」でバックアップを作成しておくと安心です。
            </div>
        </div>

        <!-- Step 2 -->
        <h2>Step 2: 修正箇所を探す</h2>

        <div class="step">
            <h3><span class="step-number">1</span>フローの構成を確認</h3>
            <p>フローは以下のような構成になっています：</p>
            <ol>
                <li><strong>トリガー：</strong>「項目が作成されたとき」（SharePoint）</li>
                <li><strong>承認：</strong>「開始して承認を待機」</li>
                <li><strong>条件：</strong>「承認」か「却下」かで分岐</li>
                <li><strong>Teams通知：</strong>承認/却下それぞれでメッセージ送信</li>
            </ol>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>Teams通知アクションを探す</h3>
            <ol>
                <li>「条件」アクションを展開（クリックして開く）</li>
                <li><strong>「はいの場合」</strong>（承認時）の中を確認</li>
                <li><strong>「チャットまたはチャネルでメッセージを投稿する」</strong> または <strong>「ユーザーにフロー ボットとしてチャットする」</strong> アクションを探す</li>
            </ol>

            <div class="explanation">
                <h4>探すポイント</h4>
                <p>メッセージ本文に以下のような式が含まれているアクションを探してください：</p>
                <div class="code-block">¥@{add(triggerOutputs()?['body/報奨金額'], triggerOutputs()?['body/事前ボーナス'])}</div>
            </div>
        </div>

        <!-- Step 3 -->
        <h2>Step 3: 報奨金の式を修正する</h2>

        <div class="step">
            <h3><span class="step-number">1</span>現在の式を確認</h3>
            <p>メッセージ内の報奨金表示部分は、現在このようになっています：</p>

            <div class="before-after">
                <div class="before-box">
                    <div class="label">変更前（現在の式）</div>
                    <div class="content">
                        <div class="code-block">¥@{add(triggerOutputs()?['body/報奨金額'], triggerOutputs()?['body/事前ボーナス'])}</div>
                    </div>
                </div>
            </div>

            <div class="explanation">
                <h4>現在の式の問題点</h4>
                <ul>
                    <li>報奨金が0円の場合、「¥5,000」や「¥0」と表示されてしまう</li>
                    <li>「受験料相当額」という表示ができない</li>
                    <li>事前申請ボーナスの有無が分かりにくい</li>
                </ul>
            </div>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>新しい式に置き換える</h3>

            <div class="before-after">
                <div class="after-box">
                    <div class="label">変更後（新しい式）</div>
                    <div class="content">
                        <div class="code-block">@{if(equals(triggerOutputs()?['body/報奨金額'], 0), if(greater(triggerOutputs()?['body/事前ボーナス'], 0), '¥5,000（事前申請ボーナス）+ 受験料相当額', '受験料相当額'), if(greater(triggerOutputs()?['body/事前ボーナス'], 0), concat('¥', formatNumber(triggerOutputs()?['body/報奨金額'], '#,##0'), ' + ¥5,000（事前申請ボーナス）'), concat('¥', formatNumber(triggerOutputs()?['body/報奨金額'], '#,##0'))))}</div>
                    </div>
                </div>
            </div>

            <div class="copy-hint">
                上の式を選択して <strong>Ctrl+C</strong> でコピーしてください
            </div>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span>式を貼り付ける手順</h3>
            <ol>
                <li>Teams通知アクションをクリックして展開</li>
                <li>メッセージ本文の中で、報奨金を表示している部分を探す</li>
                <li>古い式 <code class="code-inline">¥@{add(...)}</code> を <strong>削除</strong></li>
                <li>新しい式を <strong>貼り付け</strong>（Ctrl+V）</li>
            </ol>

            <div class="warning">
                <strong>式の入力方法</strong><br>
                <ol>
                    <li>メッセージ欄をクリック</li>
                    <li>「動的なコンテンツ」ではなく「式」タブをクリック（または直接入力）</li>
                    <li>古い部分を消して、新しい式を貼り付け</li>
                </ol>
            </div>
        </div>

        <!-- 式の解説 -->
        <h2>式の解説（参考）</h2>

        <div class="step">
            <h3>式のロジック</h3>
            <div class="explanation">
                <h4>この式は何をしているか？</h4>
                <ol>
                    <li><strong>まず報奨金額が0円かチェック</strong>
                        <ul>
                            <li>0円の場合 → 「受験料相当額」系の表示へ</li>
                            <li>0円以外 → 通常の金額表示へ</li>
                        </ul>
                    </li>
                    <li><strong>次に事前ボーナスがあるかチェック</strong>
                        <ul>
                            <li>ある（5000円）→ 「+ ¥5,000（事前申請ボーナス）」を追加</li>
                            <li>ない（0円）→ ボーナス表示なし</li>
                        </ul>
                    </li>
                    <li><strong>金額にカンマを付けて表示</strong>
                        <ul>
                            <li><code class="code-inline">formatNumber(..., '#,##0')</code> で10000を10,000に変換</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <h3>式の構造（分解）</h3>
            <div class="code-block">if(
  equals(報奨金額, 0),

  // 報奨金が0円の場合
  if(
    greater(事前ボーナス, 0),
    '¥5,000（事前申請ボーナス）+ 受験料相当額',  // 宣言届
    '受験料相当額'                                // 取得届
  ),

  // 報奨金が0円以外の場合
  if(
    greater(事前ボーナス, 0),
    '¥XX,XXX + ¥5,000（事前申請ボーナス）',      // 宣言届
    '¥XX,XXX'                                     // 取得届
  )
)</div>
        </div>

        <!-- Step 4 -->
        <h2>Step 4: 却下通知も修正する（任意）</h2>

        <div class="step">
            <p>承認通知だけでなく、却下通知にも報奨金を表示している場合は、同様に修正してください。</p>
            <ol>
                <li>「条件」アクションの <strong>「いいえの場合」</strong>（却下時）を開く</li>
                <li>Teams通知アクションを探す</li>
                <li>報奨金の表示があれば、同じ式に置き換える</li>
            </ol>
        </div>

        <!-- Step 5 -->
        <h2>Step 5: 保存してテスト</h2>

        <div class="step">
            <h3><span class="step-number">1</span>フローを保存</h3>
            <ol>
                <li>画面右上の <strong>「保存」</strong> ボタンをクリック</li>
                <li>「フローが保存されました」と表示されるまで待つ</li>
            </ol>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>テスト方法</h3>
            <ol>
                <li>Power Appsから <strong>FP 3級 + 資格取得宣言届</strong> で申請を作成</li>
                <li>承認者として承認を実行</li>
                <li>Teamsの通知メッセージを確認</li>
                <li>「¥5,000（事前申請ボーナス）+ 受験料相当額」と表示されればOK</li>
            </ol>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span>テストケース</h3>
            <table>
                <thead>
                    <tr>
                        <th>テスト内容</th>
                        <th>申請内容</th>
                        <th>期待する表示</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>FP3級 + 宣言届</td>
                        <td>報奨金0円、事前ボーナス5000円</td>
                        <td>¥5,000（事前申請ボーナス）+ 受験料相当額</td>
                    </tr>
                    <tr>
                        <td>FP3級 + 取得届</td>
                        <td>報奨金0円、事前ボーナス0円</td>
                        <td>受験料相当額</td>
                    </tr>
                    <tr>
                        <td>日商簿記2級 + 宣言届</td>
                        <td>報奨金10000円、事前ボーナス5000円</td>
                        <td>¥10,000 + ¥5,000（事前申請ボーナス）</td>
                    </tr>
                    <tr>
                        <td>日商簿記2級 + 取得届</td>
                        <td>報奨金10000円、事前ボーナス0円</td>
                        <td>¥10,000</td>
                    </tr>
                </tbody>
            </table>

            <div class="success">
                <strong>すべてのテストが成功したら完了です！</strong>
            </div>
        </div>

        <!-- トラブルシューティング -->
        <h2>トラブルシューティング</h2>

        <div class="step">
            <h3>Q1: 式を貼り付けたらエラーになった</h3>
            <ul>
                <li>式の前後に余分なスペースや改行が入っていないか確認</li>
                <li>式の先頭が <code class="code-inline">@{</code> で始まっているか確認</li>
                <li>式の末尾が <code class="code-inline">}</code> で終わっているか確認</li>
            </ul>
        </div>

        <div class="step">
            <h3>Q2: 保存できない</h3>
            <ul>
                <li>フローに他のエラーがないか確認（赤い警告マーク）</li>
                <li>ブラウザを更新してやり直す</li>
            </ul>
        </div>

        <div class="step">
            <h3>Q3: テストで正しく表示されない</h3>
            <ul>
                <li>SharePointリストの「報奨金額」「事前ボーナス」に正しい値が入っているか確認</li>
                <li>Power Appsの Patch 関数で正しい値を送信しているか確認</li>
            </ul>
        </div>

        <!-- 作業チェックリスト -->
        <h2>作業チェックリスト</h2>

        <div class="step">
            <div class="check-item">Power Automateにログインした</div>
            <div class="check-item">「資格取得申請_承認フロー」を開いた</div>
            <div class="check-item">承認時のTeams通知アクションを見つけた</div>
            <div class="check-item">報奨金の古い式を新しい式に置き換えた</div>
            <div class="check-item">フローを保存した</div>
            <div class="check-item">テスト申請で正しく表示された</div>
        </div>

        <footer>
            <p>資格取得申請システム（M365） - Power Automate改良ガイド</p>
            <p>作成日: 2026年1月15日</p>
        </footer>
    </div>
</body>
</html>
