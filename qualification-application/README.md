# 資格取得申請システム（M365）

## 概要
従業員の資格取得申請をMicrosoft 365で電子化するシステム

## システム構成
- **SharePoint Lists**: データ管理（資格マスタ、資格取得申請）
- **Power Apps**: 申請フォーム
- **Power Automate**: 承認ワークフロー + Teams通知

## 主な機能
- 資格名＋詳細（級）による正確な報奨金表示
- 事前申請ボーナス（+5,000円）対応
- 受験料相当額表示（報奨金0円の資格用）
- 申請種別に応じた動的ラベル切り替え

## 申請フロー
1. 従業員が資格取得を決意 → 宣言届を申請（事前申請で+5,000円）
2. 従業員が資格を取得 → 取得届を申請
3. 承認者にTeams通知 → 承認/却下
4. 結果が申請者に通知

## 報奨金ルール

| 申請種別 | 報奨金 | 事前ボーナス | 説明 |
|---------|--------|------------|------|
| 資格取得宣言届 | 0円（表示しない） | 0円 | 事前の宣言のみ。報奨金は取得届提出時に確定 |
| 資格取得届（宣言届あり） | マスタから取得 | **+5,000円** | 事前に宣言届を提出していた場合ボーナス加算 |
| 資格取得届（宣言届なし） | マスタから取得 | 0円 | 報奨金のみ |

### 報奨金表示パターン（Power Apps上）

| 報奨金 | 宣言届の有無 | 表示 |
|--------|------------|------|
| - | 宣言届の場合 | ※この届出では報奨金は発生しません... |
| 0円（FP3級など） | 宣言届あり | 受験料相当額 + ¥5,000（事前申請ボーナス） |
| 0円（FP3級など） | 宣言届なし | 受験料相当額 |
| 通常 | 宣言届あり | ¥XX,XXX + ¥5,000（事前申請ボーナス） |
| 通常 | 宣言届なし | ¥XX,XXX |

## ファイル構成

### ドキュメント（Markdown）
- `01_sharepoint-lists.md` - SharePointリスト設計
- `02_power-apps.md` - Power Apps設計・作成手順
- `03_power-automate.md` - Power Automate設計・作成手順
- `04_teams-notification.md` - Teams通知設定

### 差分調査・修正プラン
- **[`05_gap-analysis-and-fix-plan.md`](05_gap-analysis-and-fix-plan.md)** - 差分調査・現状分析・修正プラン（Markdown版）（2026-02-09）
- **[`06_pending-actions.md`](06_pending-actions.md)** - 保留中のアクション一覧（TODO）
- **[`差分調査_修正プラン_完全版.html`](差分調査_修正プラン_完全版.html)** - 差分調査・現状分析・修正プラン（HTML版）（2026-02-09）

### 🆕 確定版 修正手順書（2026-02-10 追加）
- **[`資格申請システム_修正手順書_完全版.html`](資格申請システム_修正手順書_完全版.html)** - **← 最新版：Phase 0 調査完了後の確定版修正手順書（コピペ対応）**

### HTMLガイド（初心者向け）
- `power-apps-improvement-guide.html` - Power Apps改良ガイド
- `power-automate-improvement-guide.html` - Power Automate改良ガイド
- `PowerApps_修正後UIイメージ.html` - Power Apps 修正後のUIイメージ
- `PowerAutomate_完全設定ガイド.html` - Power Automate 完全設定ガイド（新規構築用）
- `PowerAutomate_修正手順書.html` - Power Automate 修正手順書
- `PowerAutomate_修正ガイド_詳細版.html` - Power Automate 修正ガイド（詳細版）
- `資格申請システム修正ガイド.html` - システム全体の修正ガイド

### データ
- `data/qualification_master.csv` - 資格マスタサンプルデータ

## セットアップ手順

1. SharePointリストを作成（`01_sharepoint-lists.md`参照）
2. Power Appsでフォームを作成（`02_power-apps.md`参照）
3. Power Automateで承認フローを作成（`03_power-automate.md`参照）
4. テスト実行して動作確認

## 注意事項

### Power Apps
- Distinct関数使用後は `.Selected.Value` を使用
- 報奨金は `LookUp()` 関数で取得

### Power Automate
- トリガー直後に10秒の遅延を追加
- 「項目の更新」に報奨金額と事前ボーナスを含める
- 報奨金表示は「作成」アクションで生成
- SharePoint列の内部名は環境によって異なる場合あり

## 現在の実装状況（2026-02-10 更新）

> 確定版修正手順 → **[`資格申請システム_修正手順書_完全版.html`](資格申請システム_修正手順書_完全版.html)**

| コンポーネント | 進捗 | 残作業 |
|---------------|------|--------|
| SharePoint リスト | ✅ 100% | なし |
| Power Apps | 🟡 約90% | B-1: Dropdown1フィルター改善、B-2: 関連宣言届ID送信 |
| Power Automate | 🟠 約70% | A-1〜A-6: 遅延追加、空白行削除、ステータス更新追加、却下修正 |

### Phase 0 調査結果（2026-02-10 完了）
- ✅ 条件2（事前ボーナス > 0 判定）は**既に存在**（パターンA確定 → 大規模な新規作成は不要）
- ✅ Teams通知3（ボーナスあり）・通知4（ボーナスなし）は**実装済み・内容正常**
- ✅ 条件1は「申請種別 = 宣言届」の判定（確認済み）
- 🐛 **致命的問題発見：取得届承認時にステータス更新アクションが欠落**（承認してもSharePoint上のステータスが「申請中」のまま）
- 🐛 条件1・条件2にAND空白行が残存
- 🐛 項目の更新4が却下時に「申請中」にリセットしてしまう

## 更新履歴

### 2026-02-10
- **Phase 0 調査完了**（Power Automateの条件分岐を全展開して実装状況を確認）
- 確定版 修正手順書を作成（`資格申請システム_修正手順書_完全版.html`）
- 発見事項: 条件2・Teams通知3/4は実装済み、ステータス更新アクション欠落を特定
- 修正作業 全8件（Power Automate 6件 + Power Apps 2件）を確定
- `06_pending-actions.md` をPhase 0完了状態に更新

### 2026-02-09
- 差分調査・現状分析を実施（GitHub仕様 vs 実装済み環境の比較）
- 修正プランを策定（`05_gap-analysis-and-fix-plan.md`）
- 発見された問題8件を文書化
- Power Apps修正手順・Power Automate修正手順を具体化

### 2026-01-15
- 詳細（級）ドロップダウン追加
- 4パターンの報奨金表示対応
- 受験料相当額表示対応
- 動的ラベル切り替え機能追加
- Power Automate: 遅延アクション追加、作成アクションで報奨金表示生成
