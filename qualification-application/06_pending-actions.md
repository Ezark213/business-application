# 保留中のアクション一覧

> **最終更新:** 2026年2月9日
> **ステータス:** 保留中（Phase 0 調査待ち）

---

## 現在のステータス

```
Phase 0: 追加調査     ⬜ 未着手（最優先）
Phase 1: Power Apps   ⬜ 未着手
Phase 2: Power Automate ⬜ 未着手
Phase 3: テスト       ⬜ 未着手
```

---

## Phase 0: 追加調査（最優先）

> これを先にやらないと Phase 1, 2 の作業内容が確定しない

### 調査0-1: 条件1のFalse分岐を展開して確認

**やること:**
1. Power Automate → マイフロー → 「資格取得申請_承認フロー」→ 編集
2. フロー内の「条件」（承認/却下）→ True分岐 → 「条件1」を見つける
3. **条件1の「False」分岐にある「1件のアクション」をクリック**して展開する
4. 中に何があるかスクリーンショットを撮る

**確認ポイント:**
- [ ] 「条件2」（事前ボーナス > 0 の条件分岐）はあるか？
- [ ] Teams通知（取得届＋ボーナスあり）のアクションはあるか？
- [ ] Teams通知（取得届＋ボーナスなし）のアクションはあるか？
- [ ] 項目の更新（承認済）のアクションはあるか？

**結果によって分岐:**
- **条件2がある場合** → 内容を確認して微修正のみ
- **条件2がない場合** → 新規で条件分岐 + Teams通知2つ + 項目の更新2つ を追加

### 調査0-2: 項目の更新 4 の意図を確認

**やること:**
1. 却下分岐（False）内の「For each 1 → 項目の更新 4」を展開
2. 全パラメータのスクリーンショットを撮る

**確認ポイント:**
- [ ] どのリストのどのIDを更新しているか？
- [ ] ステータスを「申請中」にしているのは意図的か？
- [ ] 関連する宣言届のリセット目的か？それとも不要か？

---

## Phase 1: Power Apps の修正

### 修正1-1: Dropdown1のフィルター改善 🔴必須

**対象:** `Dropdown1` コントロールの `Items` プロパティ

**現在（問題あり）:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
)
```

**修正後:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
        && ステータス.Value = "承認済"
        && StartsWith(Title, DropdownQualification.Selected.Value)
)
```

**変更理由:** 全ての宣言届が表示されてしまう → 同じ資格＋承認済みのみに絞る

---

### 修正1-2: Patch関数に関連宣言届IDを追加 🔴必須

**対象:** `ButtonSubmit` コントロールの `OnSelect` プロパティ

**追加するフィールド:**
```
関連宣言届ID: If(
    RadioApplicationType.Selected.Value = "資格取得届"
        && !IsBlank(Dropdown1.Selected),
    Dropdown1.Selected.ID,
    Blank()
)
```

> 既存のPatch関数の `事前ボーナス: ...` の後に追加する

---

## Phase 2: Power Automate の修正

### 修正2-1: 遅延の追加 🟡推奨

**やること:**
1. 「項目が作成されたとき」と「項目の更新 2」の間に「遅延」アクションを追加
2. カウント: `10`、単位: `秒`

---

### 修正2-2: 条件1 False分岐の修正 🔴必須

> Phase 0 の調査結果に基づいて作業内容が変わる

**パターンA（条件2が既にある場合）:**
- Teams通知の内容を確認・微修正

**パターンB（条件2がない場合）:**

1. 条件1のFalse内に「条件」を追加
   - 左辺: `事前ボーナス`（項目の更新 2から）
   - 演算子: `次の値より大きい`
   - 右辺: `0`

2. 条件2 True（ボーナスあり）に追加:
   - 項目の更新（ステータス: 承認済, 承認者, 承認日: utcNow()）
   - Teams通知（報奨金内訳表示）

3. 条件2 False（ボーナスなし）に追加:
   - 項目の更新（ステータス: 承認済, 承認者, 承認日: utcNow()）
   - Teams通知（報奨金のみ + 次回宣言届の案内）

Teams通知のメッセージ内容は [`05_gap-analysis-and-fix-plan.md`](05_gap-analysis-and-fix-plan.md) の「9. Power Automate 具体的な修正手順」を参照。

---

### 修正2-3: 承認タイトルに資格名を追加 🟢任意

**現在:** `【資格取得申請】承認依頼`
**修正後:** `【資格取得申請】承認依頼: ` + 動的コンテンツ「タイトル」

---

### 修正2-4: 項目の更新 4 の確認・修正 🟡推奨

> Phase 0-2 の調査結果に基づいて対応

---

## Phase 3: テスト

| No. | テスト内容 | 期待結果 | 確認 |
|-----|----------|---------|------|
| 1 | 宣言届 → 承認 | ステータス「承認済」、金額なしTeams通知 | ⬜ |
| 2 | 取得届（宣言届紐づけ）→ 承認 | 報奨金+¥5,000表示、関連宣言届ID記録 | ⬜ |
| 3 | 取得届（宣言届なし）→ 承認 | 報奨金のみ表示 | ⬜ |
| 4 | 却下 | ステータス「却下」、却下理由付き通知 | ⬜ |
| 5 | SharePoint確認 | 承認者・承認日が記録されている | ⬜ |

---

## 関連ドキュメント

| ファイル | 内容 |
|---------|------|
| [`05_gap-analysis-and-fix-plan.md`](05_gap-analysis-and-fix-plan.md) | 差分調査の詳細分析と修正手順（全文） |
| [`差分調査_修正プラン_完全版.html`](差分調査_修正プラン_完全版.html) | HTML版（スタイル付き） |
| [`02_power-apps.md`](02_power-apps.md) | Power Apps設計・作成手順（GitHub仕様） |
| [`03_power-automate.md`](03_power-automate.md) | Power Automate設計・作成手順（GitHub仕様） |
