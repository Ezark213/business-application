# 保留中のアクション一覧

> **最終更新:** 2026年2月10日
> **ステータス:** Phase 0 完了 → Phase 1〜3 実施待ち
> **確定版手順書:** [`資格申請システム_修正手順書_完全版.html`](資格申請システム_修正手順書_完全版.html)

---

## 現在のステータス

```
Phase 0: 追加調査       ✅ 完了（2026-02-10）
Phase 1: Power Apps     ⬜ 未着手（2件）
Phase 2: Power Automate ⬜ 未着手（6件）
Phase 3: テスト         ⬜ 未着手（5ケース）
```

---

## Phase 0: 追加調査 ✅ 完了

### 調査0-1: 条件1のFalse分岐 → ✅ 確認済み

**結果:**
- ✅ 条件2（事前ボーナス > 0）が**既に存在**（パターンA確定）
- ✅ Teams通知3（ボーナスあり）が存在し、内容正常
- ✅ Teams通知4（ボーナスなし）が存在し、内容正常
- ⚠️ 条件2にAND空白行が残存 → 修正A-3で対応
- 🐛 **条件2の各分岐に「項目の更新」（承認済ステータス設定）が存在しない** → 修正A-5で対応

### 調査0-2: 項目の更新4 → ✅ 確認済み

**結果:**
- リスト: 資格取得申請
- ID: トリガーアイテムのID
- ステータス Value: 「申請中」にリセット ← **バグ: 「却下」にすべき** → 修正A-4で対応
- 承認者 Claims: responder/user...

### 追加発見事項
- 条件1にもAND空白行が残存 → 修正A-2で対応
- 承認分岐全体にステータス更新アクションが欠落（取得届承認時にステータスが「申請中」のまま）

---

## Phase 1: Power Apps の修正 ⬜ 未着手

### B-1: Dropdown1のフィルター改善 🔴必須

**対象:** `Dropdown1` コントロールの `Items` プロパティ

**現在（問題あり）:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
)
```

**修正後:**
```
Filter(
    資格取得申請,
    申請種別.Value = "資格取得宣言届"
        && ステータス.Value = "承認済"
        && Title = DropdownQualification.Selected.Value
)
```

**変更理由:** 全ての宣言届が表示されてしまう → 同じ資格＋承認済みのみに絞る

---

### B-2: Patch関数に関連宣言届IDを追加 🔴必須

**対象:** `ButtonSubmit` コントロールの `OnSelect` プロパティ

**追加するフィールド:**
```
関連宣言届ID: If(
    RadioApplicationType.Selected.Value = "資格取得届"
        && !IsBlank(Dropdown1.Selected),
    Dropdown1.Selected.ID,
    Blank()
)
```

> 既存のPatch関数内に追加する

---

## Phase 2: Power Automate の修正 ⬜ 未着手

### A-1: 遅延の追加 🟡推奨

トリガー直後に「遅延」アクションを追加（カウント: 10、単位: 秒）

---

### A-2: 条件1のAND空白行を削除 🔴必須

条件1のCondition expressionの2行目（空白行）を「…」→「削除」

---

### A-3: 条件2のAND空白行を削除 🔴必須

条件2のCondition expressionの2行目（空白行）を「…」→「削除」

---

### A-4: 項目の更新4のステータスを修正 🔴必須

**変更:** ステータス Value を「申請中」→「**却下**」に変更

---

### A-5: 承認時のステータス更新アクションを追加 🔴必須 ⚠️最重要

**致命的な問題:** 現在、承認されてもSharePoint上のステータスが「申請中」のまま更新されない。

**やること:**
1. 条件 True → 条件1 の**間**に「項目の更新」アクションを追加
2. 設定:
   - サイト: armaascojp.sharepoint.com/sites/arma-as.co.jp
   - リスト: 資格取得申請
   - ID: 動的コンテンツ「ID」
   - ステータス Value: **承認済**
   - 承認者 Claims: 動的コンテンツ「応答者 ユーザー プリンシパル名」
   - 承認日: 式 `utcNow()`

---

### A-6: 承認タイトルに資格名を追加 🟢任意

「開始して承認を待機」のタイトルを `【資格取得申請】承認依頼: ` + 動的コンテンツ「タイトル」に変更

---

## Phase 3: テスト ⬜ 未着手

| No. | テスト内容 | 期待結果 | 確認 |
|-----|----------|---------|------|
| 1 | 宣言届 → 承認 | ステータス「承認済」、承認者・承認日記録、Teams通知2 | ⬜ |
| 2 | 取得届（宣言届紐づけ）→ 承認 | 報奨金+¥5,000表示、関連宣言届ID記録、Teams通知3 | ⬜ |
| 3 | 取得届（宣言届なし）→ 承認 | 報奨金のみ表示、「次回は宣言届を」メッセージ、Teams通知4 | ⬜ |
| 4 | 却下 | ステータス「却下」、却下理由付きTeams通知1 | ⬜ |
| 5 | SharePoint確認 | 全レコードの承認者・承認日・関連宣言届ID が正しく記録されている | ⬜ |

---

## 関連ドキュメント

| ファイル | 内容 |
|---------|------|
| [`資格申請システム_修正手順書_完全版.html`](資格申請システム_修正手順書_完全版.html) | **🆕 確定版修正手順書（コピペ対応・初心者向け）** |
| [`05_gap-analysis-and-fix-plan.md`](05_gap-analysis-and-fix-plan.md) | 差分調査の詳細分析と修正手順（全文） |
| [`差分調査_修正プラン_完全版.html`](差分調査_修正プラン_完全版.html) | HTML版（スタイル付き） |
| [`02_power-apps.md`](02_power-apps.md) | Power Apps設計・作成手順（GitHub仕様） |
| [`03_power-automate.md`](03_power-automate.md) | Power Automate設計・作成手順（GitHub仕様） |
