{
  "name": "Teams承認通知フロー",
  "description": "承認ステータスが「申請中」に変更されたとき、承認者にTeams通知を送信するフロー",
  "lastUpdated": "2026-01-19",

  "flows": [
    {
      "name": "申請時承認者通知",
      "description": "経費申請が「申請中」になったとき、承認者にTeamsで通知",
      "trigger": {
        "type": "SharePointListItemCreatedOrModified",
        "displayName": "項目が作成または変更されたとき",
        "parameters": {
          "siteAddress": "{SharePointSiteUrl}",
          "listName": "ExpenseRequests"
        }
      },
      "actions": [
        {
          "order": 1,
          "name": "条件",
          "displayName": "承認ステータスが「申請中」か確認",
          "type": "Condition",
          "expression": "@equals(triggerOutputs()?['body/承認ステータス/Value'], '申請中')",
          "ifTrue": {
            "actions": [
              {
                "order": 2,
                "name": "Teamsメッセージ送信",
                "displayName": "承認者へチャットで通知",
                "type": "PostMessageToTeamsUser",
                "parameters": {
                  "recipient": "{ApproverEmail}",
                  "messageType": "Text",
                  "message": "【経費申請の承認依頼】\n\n申請者: @{triggerOutputs()?['body/申請者/DisplayName']}\n申請タイトル: @{triggerOutputs()?['body/Title']}\n申請日: @{formatDateTime(triggerOutputs()?['body/申請日'], 'yyyy/MM/dd')}\n\n以下のリンクから確認してください：\n@{triggerOutputs()?['body/{Link}']}"
                },
                "note": "承認者のメールアドレスは固定値またはSharePointリストから取得"
              }
            ]
          },
          "ifFalse": {
            "actions": [],
            "note": "申請中以外の場合は何もしない"
          }
        }
      ],

      "setupInstructions": {
        "step1": {
          "action": "Power Automateで「自動化したクラウドフロー」を作成"
        },
        "step2": {
          "action": "トリガー「SharePoint - 項目が作成または変更されたとき」を設定",
          "settings": {
            "サイトのアドレス": "SharePointサイトURL",
            "リスト名": "ExpenseRequests"
          }
        },
        "step3": {
          "action": "「条件」アクションを追加",
          "settings": {
            "左辺": "動的コンテンツ → 承認ステータス Value",
            "演算子": "次の値に等しい",
            "右辺": "申請中"
          }
        },
        "step4": {
          "action": "「はいの場合」に「Microsoft Teams - チャットまたはチャネルでメッセージを投稿する」を追加",
          "settings": {
            "投稿者": "フローボット",
            "投稿先": "Chat with Flow bot",
            "受信者": "承認者のメールアドレス",
            "メッセージ": "上記のmessage内容を参考に設定"
          }
        }
      }
    },

    {
      "name": "承認結果通知",
      "description": "承認/却下されたとき、申請者に通知",
      "trigger": {
        "type": "SharePointListItemModified",
        "parameters": {
          "siteAddress": "{SharePointSiteUrl}",
          "listName": "ExpenseRequests"
        }
      },
      "actions": [
        {
          "order": 1,
          "name": "条件",
          "displayName": "承認済みまたは却下か確認",
          "type": "Condition",
          "expression": "@or(equals(triggerOutputs()?['body/承認ステータス/Value'], '承認済み'), equals(triggerOutputs()?['body/承認ステータス/Value'], '却下'))",
          "ifTrue": {
            "actions": [
              {
                "name": "申請者へ通知",
                "type": "PostMessageToTeamsUser",
                "parameters": {
                  "recipient": "@{triggerOutputs()?['body/申請者/Email']}",
                  "message": "【経費申請 @{triggerOutputs()?['body/承認ステータス/Value']}】\n\n申請タイトル: @{triggerOutputs()?['body/Title']}\n承認者: @{triggerOutputs()?['body/承認者/DisplayName']}\nコメント: @{triggerOutputs()?['body/承認コメント']}"
                }
              }
            ]
          }
        }
      ]
    },

    {
      "name": "週次経費サマリー",
      "description": "毎週月曜日に先週の承認済み経費をサマリー通知",
      "trigger": {
        "type": "Recurrence",
        "parameters": {
          "frequency": "Week",
          "interval": 1,
          "schedule": {
            "weekDays": ["Monday"],
            "hours": [9],
            "minutes": [0]
          }
        }
      },
      "actions": [
        {
          "name": "先週の承認済み経費を取得",
          "type": "GetItemsFromSharePointList",
          "parameters": {
            "filter": "承認ステータス eq '承認済み' and 承認日時 ge '@{addDays(utcNow(), -7)}'"
          }
        },
        {
          "name": "サマリーをTeamsチャネルに投稿",
          "type": "PostToTeamsChannel",
          "parameters": {
            "message": "週次経費サマリー（件数・合計金額）"
          }
        }
      ]
    }
  ],

  "approverConfiguration": {
    "option1": {
      "name": "固定承認者",
      "description": "承認者のメールアドレスをフローに直接設定",
      "example": "approver@company.com"
    },
    "option2": {
      "name": "動的承認者",
      "description": "ExpenseRequestsリストに「承認者」列（Person型）を追加し、申請時に選択させる",
      "formula": "@{triggerOutputs()?['body/承認者/Email']}"
    },
    "option3": {
      "name": "承認者マスター",
      "description": "部署ごとの承認者をマスターリストで管理",
      "lookup": "LookUp(Approvers, Department = 申請の部署).ApproverEmail"
    }
  }
}
