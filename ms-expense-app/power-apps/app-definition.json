{
  "name": "経費申請アプリ",
  "description": "Microsoft 365統合経費管理アプリケーション",
  "appType": "CanvasApp",
  "version": "2.0.0",
  "lastUpdated": "2026-01-19",
  "author": "Business Application Team",

  "dataSources": [
    {
      "name": "ExpenseRequests",
      "type": "SharePointList",
      "siteUrl": "{SharePointSiteUrl}",
      "listName": "ExpenseRequests",
      "description": "申請ヘッダー（1申請=1レコード）"
    },
    {
      "name": "ExpenseDetails",
      "type": "SharePointList",
      "siteUrl": "{SharePointSiteUrl}",
      "listName": "ExpenseDetails",
      "description": "経費明細（1経費=1レコード、申請IDで紐付け）"
    },
    {
      "name": "TaxRates",
      "type": "SharePointList",
      "siteUrl": "{SharePointSiteUrl}",
      "listName": "TaxRates",
      "description": "税区分マスター"
    }
  ],

  "globalVariables": [
    {
      "name": "varCurrentRequestID",
      "type": "Number",
      "description": "現在選択/作成中の申請ID"
    },
    {
      "name": "varNewRequest",
      "type": "Record",
      "description": "新規作成した申請レコード"
    }
  ],

  "screens": [
    {
      "name": "HomeScreen",
      "displayName": "ホーム",
      "order": 1,
      "description": "アプリのエントリーポイント",
      "components": [
        {
          "type": "Button",
          "name": "btnRequestList",
          "text": "申請一覧",
          "onSelect": "Navigate(RequestListScreen)"
        },
        {
          "type": "Button",
          "name": "btnNewRequest",
          "text": "新規申請",
          "onSelect": "Set(varNewRequest, Patch(ExpenseRequests, Defaults(ExpenseRequests), {Title: \"申請_\" & Text(Now(), \"yyyymmddhhmmss\"), '承認ステータス': {Value: \"下書き\"}})); Set(varCurrentRequestID, varNewRequest.ID); Navigate(RequestFormScreen)",
          "note": "申請者はPower Automateで自動設定するためPatchから除外"
        }
      ]
    },
    {
      "name": "RequestListScreen",
      "displayName": "申請一覧",
      "order": 2,
      "description": "申請一覧画面（ギャラリー表示）",
      "components": [
        {
          "type": "Rectangle",
          "name": "rectHeader",
          "properties": {
            "X": 0,
            "Y": 0,
            "Width": "Parent.Width",
            "Height": 70,
            "Fill": "RGBA(0, 120, 212, 1)"
          }
        },
        {
          "type": "Label",
          "name": "lblBack",
          "text": "← 戻る",
          "onSelect": "Navigate(HomeScreen)",
          "properties": {
            "Color": "White",
            "FontWeight": "FontWeight.Bold"
          }
        },
        {
          "type": "Label",
          "name": "lblTitle",
          "text": "申請一覧",
          "properties": {
            "Align": "Align.Center",
            "Color": "White",
            "Size": 20
          }
        },
        {
          "type": "Button",
          "name": "btnNewRequest",
          "text": "+ 新規申請",
          "onSelect": "Set(varNewRequest, Patch(ExpenseRequests, Defaults(ExpenseRequests), {Title: \"申請_\" & Text(Now(), \"yyyymmddhhmmss\"), '承認ステータス': {Value: \"下書き\"}})); Set(varCurrentRequestID, varNewRequest.ID); Navigate(RequestFormScreen)"
        },
        {
          "type": "Label",
          "name": "lblHeaderDate",
          "text": "日付",
          "location": "OutsideGallery",
          "note": "ヘッダーラベルはギャラリーの外に配置"
        },
        {
          "type": "Label",
          "name": "lblHeaderDept",
          "text": "部署",
          "location": "OutsideGallery"
        },
        {
          "type": "Label",
          "name": "lblHeaderAmount",
          "text": "税込金額",
          "location": "OutsideGallery"
        },
        {
          "type": "Label",
          "name": "lblHeaderAccount",
          "text": "勘定科目",
          "location": "OutsideGallery"
        },
        {
          "type": "Gallery",
          "name": "galRequests",
          "dataSource": "ExpenseRequests",
          "properties": {
            "Items": "ExpenseRequests",
            "TemplateSize": 45,
            "TemplatePadding": 2
          },
          "templateLabels": [
            {
              "name": "lblDate",
              "text": "Text(ThisItem.'経費日付', \"mm/dd\")"
            },
            {
              "name": "lblDept",
              "text": "ThisItem.'部署'"
            },
            {
              "name": "lblAmount",
              "text": "Text(ThisItem.'税込金額', \"¥#,##0\")",
              "note": "カンマ区切り表示"
            },
            {
              "name": "lblAccount",
              "text": "ThisItem.'勘定科目'.Value",
              "note": "Choice列なので.Value必須"
            }
          ],
          "onSelect": "Set(varCurrentRequestID, ThisItem.ID); Navigate(RequestFormScreen)"
        }
      ]
    },
    {
      "name": "RequestFormScreen",
      "displayName": "申請作成",
      "order": 3,
      "description": "申請作成・経費明細一覧画面",
      "components": [
        {
          "type": "Label",
          "name": "lblBack",
          "text": "← 戻る",
          "onSelect": "Navigate(RequestListScreen)"
        },
        {
          "type": "DatePicker",
          "name": "dpRequestDate",
          "properties": {
            "DefaultDate": "Today()"
          }
        },
        {
          "type": "TextInput",
          "name": "txtDepartment",
          "properties": {
            "Default": "",
            "HintText": "例: 営業部"
          }
        },
        {
          "type": "Gallery",
          "name": "galDetails",
          "dataSource": "ExpenseDetails",
          "properties": {
            "Items": "Filter(ExpenseDetails, 申請ID = varCurrentRequestID)",
            "TemplateSize": 45,
            "TemplatePadding": 2
          },
          "templateLabels": [
            {
              "name": "lblDetailDate",
              "text": "Text(ThisItem.'経費日付', \"mm/dd\")"
            },
            {
              "name": "lblDetailContent",
              "text": "ThisItem.'内容'"
            },
            {
              "name": "lblDetailAmount",
              "text": "Text(ThisItem.'税込金額', \"¥#,##0\")"
            },
            {
              "name": "lblDelete",
              "text": "削除",
              "onSelect": "Remove(ExpenseDetails, ThisItem)",
              "color": "RGBA(220, 53, 69, 1)"
            }
          ]
        },
        {
          "type": "Label",
          "name": "lblTotalInfo",
          "text": "\"合計: \" & CountRows(galDetails.AllItems) & \" 件 / \" & Text(Sum(galDetails.AllItems, '税込金額'), \"¥#,##0\")",
          "note": "galDetails作成後に設定すること"
        },
        {
          "type": "Button",
          "name": "btnAddExpense",
          "text": "+ 経費を追加",
          "onSelect": "Navigate(DetailFormScreen)",
          "fill": "RGBA(255, 193, 7, 1)"
        },
        {
          "type": "Button",
          "name": "btnSubmit",
          "text": "申請する",
          "onSelect": "Patch(ExpenseRequests, LookUp(ExpenseRequests, ID = varCurrentRequestID), {'承認ステータス': {Value: \"申請中\"}}); Notify(\"申請しました\", NotificationType.Success); Navigate(RequestListScreen)"
        }
      ]
    },
    {
      "name": "DetailFormScreen",
      "displayName": "経費を追加",
      "order": 4,
      "description": "経費明細入力画面",
      "components": [
        {
          "type": "DatePicker",
          "name": "dpExpenseDate",
          "properties": {
            "DefaultDate": "Today()"
          }
        },
        {
          "type": "Dropdown",
          "name": "ddAccountItem",
          "properties": {
            "Items": "[\"会議費\",\"交際費\",\"旅費交通費\",\"通信費\",\"消耗品費\",\"諸会費\",\"保険料\",\"租税公課\",\"支払手数料\",\"新聞図書費\"]"
          }
        },
        {
          "type": "TextInput",
          "name": "txtContent",
          "properties": {
            "HintText": "例: 新幹線 東京-大阪"
          }
        },
        {
          "type": "TextInput",
          "name": "txtAmount",
          "properties": {
            "Format": "TextFormat.Number"
          }
        },
        {
          "type": "Dropdown",
          "name": "ddTaxCategory",
          "properties": {
            "Items": "TaxRates"
          }
        },
        {
          "type": "Label",
          "name": "lblTaxAmount",
          "text": "If(IsBlank(txtAmount.Text), \"税額: ¥0\", \"税額: \" & Text(Value(txtAmount.Text) - Value(txtAmount.Text) / 1.1, \"¥#,##0\"))",
          "note": "空欄時のエラー対策でIsBlank判定"
        },
        {
          "type": "Label",
          "name": "lblNetAmount",
          "text": "If(IsBlank(txtAmount.Text), \"税抜: ¥0\", \"税抜: \" & Text(Value(txtAmount.Text) / 1.1, \"¥#,##0\"))"
        },
        {
          "type": "Button",
          "name": "btnCancel",
          "text": "キャンセル",
          "onSelect": "Navigate(RequestFormScreen)",
          "fill": "RGBA(108, 117, 125, 1)"
        },
        {
          "type": "Button",
          "name": "btnAdd",
          "text": "追加",
          "onSelect": "Patch(ExpenseDetails, Defaults(ExpenseDetails), {Title: txtContent.Text, '経費日付': dpExpenseDate.SelectedDate, '勘定科目': {Value: ddAccountItem.Selected.Value}, '内容': txtContent.Text, '税込金額': Value(txtAmount.Text), '申請ID': varCurrentRequestID}); Navigate(RequestFormScreen)",
          "note": "コントロール名は実際の名前に合わせて変更"
        }
      ]
    }
  ],

  "knownIssuesAndSolutions": {
    "personColumnError": {
      "issue": "申請者（Person列）をPatchで設定するとエラー",
      "solution": "Power Automateで自動設定。Patch式から申請者を除外する",
      "relatedFlow": "applicant-auto-set-flow.json"
    },
    "thisItemNotRecognized": {
      "issue": "'ThisItem' は認識されませんエラー",
      "solution": "ラベルがギャラリー外にある。ギャラリーの1行目（テンプレート行）を選択してから挿入"
    },
    "textValueRequired": {
      "issue": "Text値が必要です。Recordを生成しますエラー",
      "solution": "Choice列には.Valueを付ける（例: ThisItem.'勘定科目'.Value）"
    },
    "headerLabelError": {
      "issue": "ヘッダーラベルでThisItemエラー",
      "solution": "ヘッダーラベルはギャラリーの外に配置する"
    }
  },

  "theme": {
    "primaryColor": "#0078D4",
    "accentColor": "#106EBE",
    "backgroundColor": "#F3F2F1",
    "fontFamily": "Segoe UI"
  },

  "settings": {
    "requiresAuthentication": true,
    "defaultScreen": "HomeScreen"
  }
}
