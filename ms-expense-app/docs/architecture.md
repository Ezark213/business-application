# アーキテクチャ設計書

## 1. システム概要

### 1.1 目的
Python/Tkinter製の経費計上アプリをMicrosoft 365プラットフォームに移行し、
承認ワークフロー、Teams連携、SharePoint統合を実現する。

### 1.2 対象ユーザー
- 一般社員（経費申請者）
- 部署管理者（承認者）
- 経理担当者（管理者）

## 2. アーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Microsoft 365 テナント                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐                                                   │
│  │   Power Apps    │◀──────────────────────────────────┐               │
│  │  Canvas App     │                                   │               │
│  │  (フロントエンド)│                                   │               │
│  └────────┬────────┘                                   │               │
│           │                                            │               │
│           ▼                                            │               │
│  ┌─────────────────────────────────────────────────────┴──────────┐   │
│  │                      SharePoint Online                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │   │
│  │  │ExpenseRequests│  │  Approvers   │  │     TaxRates        │ │   │
│  │  │   (リスト)    │  │  (リスト)    │  │     (リスト)        │ │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────────┘ │   │
│  │                                                                │   │
│  │  ┌──────────────────────────────────────────────────────────┐ │   │
│  │  │              ドキュメントライブラリ                       │ │   │
│  │  │              (領収書・添付ファイル)                       │ │   │
│  │  └──────────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────┬────────────────────────────────┘   │
│                                  │                                     │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                       Power Automate                            │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐  │  │
│  │  │  承認フロー     │  │ Teams通知フロー │  │ Excelエクスポート│  │  │
│  │  │  (Approvals)    │  │ (通知・サマリー)│  │   フロー       │  │  │
│  │  └─────────────────┘  └─────────────────┘  └────────────────┘  │  │
│  └───────────────────────────────┬────────────────────────────────┘   │
│                                  │                                     │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                     Microsoft Teams                             │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐  │  │
│  │  │ 承認リクエスト  │  │ 通知チャネル    │  │ アプリタブ     │  │  │
│  │  │ (Adaptive Card) │  │ (自動投稿)      │  │ (Power Apps)   │  │  │
│  │  └─────────────────┘  └─────────────────┘  └────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント詳細

#### Power Apps (フロントエンド)
| 画面 | 機能 |
|------|------|
| ホーム | ダッシュボード、サマリータイル、最近の申請 |
| 申請フォーム | 新規作成・編集、税額自動計算、添付ファイル |
| 一覧 | 検索・フィルター、ステータス管理 |
| 詳細 | 申請内容表示、再申請、削除 |
| 承認管理 | 承認待ち一覧、承認・却下操作 |
| レポート | グラフ、集計表、Excelエクスポート |

#### SharePoint Lists (データストア)
| リスト | 用途 |
|--------|------|
| ExpenseRequests | 経費申請データ本体 |
| Approvers | 部署別承認者マスタ |
| TaxRates | 税計算パラメータマスタ |

#### Power Automate (ワークフロー)
| フロー | トリガー | アクション |
|--------|----------|------------|
| 承認フロー | 申請ステータス「申請中」 | 承認者へ承認リクエスト送信、結果をSPに反映 |
| Teams通知 | ステータス変更 | Teamsチャネルへ投稿 |
| 週次サマリー | 毎週月曜9時 | 前週の承認済み経費をサマリー投稿 |
| Excelエクスポート | ボタン押下 | Excelファイル生成、OneDriveへ保存 |

## 3. データフロー

### 3.1 申請フロー
```
申請者                Power Apps              SharePoint           Power Automate          承認者
  │                      │                       │                      │                  │
  │─── フォーム入力 ────▶│                       │                      │                  │
  │                      │── アイテム作成 ──────▶│                      │                  │
  │                      │                       │── トリガー発火 ─────▶│                  │
  │                      │                       │                      │── 承認依頼 ────▶│
  │                      │                       │                      │                  │
  │                      │                       │                      │◀── 承認/却下 ───│
  │                      │                       │◀── ステータス更新 ──│                  │
  │◀─── Teams通知 ───────│                       │                      │                  │
```

### 3.2 税額計算フロー
```
Power Apps                              SharePoint (TaxRates)
    │                                          │
    │── 税区分選択 ────────────────────────────▶│
    │                                          │
    │◀─ 税率・除数・乗数取得 ──────────────────│
    │                                          │
    │   税額 = RoundDown(税込金額 / 除数 * 乗数)
    │   税抜 = 税込金額 - 税額
    │
```

## 4. セキュリティ

### 4.1 アクセス制御
- **SharePoint Lists**: アイテムレベルのアクセス許可
  - 申請者: 自分のアイテムのみ編集可能
  - 承認者: 担当部署のアイテムを閲覧・承認可能
  - 経理: 全アイテム閲覧・エクスポート可能

### 4.2 Power Apps アクセス制御
- Azure ADセキュリティグループによる共有
- 承認者画面は承認者グループのみ表示

### 4.3 データ保護
- SharePointの監査ログ有効化
- バージョン履歴による変更追跡
- DLPポリシーによる外部共有制限

## 5. 可用性・パフォーマンス

### 5.1 オフライン対応
- Power Apps のオフラインモード有効化
- ローカルキャッシュからの参照
- オンライン復帰時に同期

### 5.2 パフォーマンス最適化
- SharePoint Lists のインデックス作成
- ビューの適切なフィルター設定
- 委任可能なクエリの使用

## 6. 拡張性

### 6.1 将来の拡張案
- **Dataverse移行**: 大規模展開時
- **Power BI連携**: 詳細分析ダッシュボード
- **会計ソフト連携**: APIまたはRPA経由で仕訳データ連携
- **モバイルアプリ**: Power Apps Mobileによるネイティブ体験

## 7. 元アプリからの機能マッピング

| 元機能 | MS版実装 |
|--------|----------|
| CSV保存 | SharePoint Lists |
| Decimal精度計算 | Power Fx (小数点以下切り捨て) |
| 8パターン税区分 | TaxRatesマスタ + 計算式 |
| 17種類勘定科目 | Choiceフィールド |
| 弥生/freee/MF出力 | Power Automate + Excel |
| 領収書添付 | SharePoint ドキュメントライブラリ |
| 検索・フィルター | Power Apps Gallery + Filter |
| 承認フロー (新規) | Power Automate Approvals |
| Teams通知 (新規) | Adaptive Cards |
